<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <title>Autodirecto CRM</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        },
                        primary: {
                            500: '#3b82f6',
                            600: '#2563eb',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .badge {
            @apply px-2 py-1 rounded-full text-xs font-semibold;
        }
        .badge-available { @apply bg-green-900 text-green-300 border border-green-700; }
        .badge-sold { @apply bg-orange-900 text-orange-300 border border-orange-700; }
        .badge-draft_dte { @apply bg-blue-900 text-blue-300 border border-blue-700; }
        .badge-sent_dte { @apply bg-purple-900 text-purple-300 border border-purple-700; }
        .insp-input {
            width: 100%;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 8px 12px;
            color: #f1f5f9;
            font-size: 0.8125rem;
            outline: none;
            transition: border-color 0.15s;
        }
        .insp-input:focus { border-color: #f59e0b; }
        .insp-input option { background: #1e293b; }
    </style>
</head>

<body x-data="appData()" x-init="init()" class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 glass flex flex-col border-r border-slate-700">
        <div class="h-16 flex items-center justify-center border-b border-slate-700">
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                Autodirecto CRM
            </h1>
        </div>
        <nav class="flex-1 px-4 py-6 space-y-2">
            <a href="#" @click.prevent="currentView='dashboard'"
                :class="currentView==='dashboard' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                <i class="ph ph-squares-four text-xl mr-3"
                    :class="currentView==='dashboard' ? 'text-blue-400' : ''"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="#" @click.prevent="currentView='dashboard'"
                :class="currentView==='inventario' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                <i class="ph ph-car text-xl mr-3"></i>
                <span class="font-medium">Inventario</span>
            </a>
            <a href="#" @click.prevent="currentView='dashboard'"
                :class="currentView==='dtes' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                <i class="ph ph-file-text text-xl mr-3"></i>
                <span class="font-medium">DTEs</span>
            </a>

            <div class="pt-4 pb-2">
                <p class="px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Apps</p>
            </div>

            <a href="#" @click.prevent="currentView='funnels'"
                :class="currentView==='funnels' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                <i class="ph ph-funnel text-xl mr-3" :class="currentView==='funnels' ? 'text-green-400' : ''"></i>
                <span class="font-medium">Funnels</span>
                <span
                    class="ml-auto bg-green-500/20 text-green-400 text-xs px-2 py-0.5 rounded-full font-semibold">Live</span>
            </a>

            <a href="#" @click.prevent="currentView='crm'; loadCRM()"
                :class="currentView==='crm' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                <i class="ph ph-address-book text-xl mr-3" :class="currentView==='crm' ? 'text-purple-400' : ''"></i>
                <span class="font-medium">CRM</span>
                <span class="ml-auto bg-purple-500/20 text-purple-400 text-xs px-2 py-0.5 rounded-full font-semibold"
                    x-text="crmStats.total || ''"></span>
            </a>

            <a href="#" @click.prevent="currentView='calendar'; loadCalendar()"
                :class="currentView==='calendar' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                <i class="ph ph-calendar-dots text-xl mr-3"
                    :class="currentView==='calendar' ? 'text-cyan-400' : ''"></i>
                <span class="font-medium">Calendario</span>
            </a>

            <a href="#" @click.prevent="currentView='consignaciones'; loadConsignaciones()"
                :class="currentView==='consignaciones' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                <i class="ph ph-clipboard-text text-xl mr-3"
                    :class="currentView==='consignaciones' ? 'text-amber-400' : ''"></i>
                <span class="font-medium">Consignaciones</span>
            </a>

            <div class="border-t border-slate-700 mt-4 pt-4">
                <a href="#" @click.prevent="currentView='usuarios'; loadUsuarios()"
                    :class="currentView==='usuarios' ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-white'"
                    class="flex items-center px-4 py-3 rounded-lg group transition-colors">
                    <i class="ph ph-users text-xl mr-3" :class="currentView==='usuarios' ? 'text-indigo-400' : ''"></i>
                    <span class="font-medium">Usuarios</span>
                </a>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold"
                        :style="'background:' + (currentUser?.color || '#8b5cf6')"
                        x-text="(currentUser?.name || 'A').charAt(0)"></div>
                    <div class="ml-3">
                        <p class="text-sm font-medium text-white" x-text="currentUser?.name || 'Admin'"></p>
                        <p class="text-xs text-slate-500" x-text="currentUser?.role || 'admin'"></p>
                    </div>
                </div>
                <button @click="doLogout()" title="Cerrar sesi√≥n"
                    class="text-slate-500 hover:text-red-400 transition-colors p-1">
                    <i class="ph ph-sign-out text-lg"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content: Dashboard View -->
    <main x-show="currentView==='dashboard'" class="flex-1 flex flex-col overflow-hidden relative">
        <!-- Header -->
        <header class="h-16 glass border-b border-slate-700 flex items-center justify-between px-8">
            <h2 class="text-lg font-semibold text-white">Inventario de Veh√≠culos</h2>
            <button @click="openModal('addCar')"
                class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center">
                <i class="ph ph-plus mr-2"></i> Nuevo Auto
            </button>
        </header>

        <!-- Stats Grid -->
        <div class="p-8 pb-4 grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- Card 1 -->
            <div class="glass p-6 rounded-xl hover:bg-slate-800/50 transition-colors">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-400 text-sm mb-1">Total Autos</p>
                        <h3 class="text-2xl font-bold text-white" x-text="stats.total">0</h3>
                    </div>
                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400">
                        <i class="ph ph-car text-xl"></i>
                    </div>
                </div>
            </div>
            <!-- Card 2 -->
            <div class="glass p-6 rounded-xl hover:bg-slate-800/50 transition-colors">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-400 text-sm mb-1">Comisiones (Mes)</p>
                        <h3 class="text-2xl font-bold text-green-400" x-text="formatCLP(stats.total_commission)">$0</h3>
                    </div>
                    <div class="p-2 bg-green-500/10 rounded-lg text-green-400">
                        <i class="ph ph-money text-xl"></i>
                    </div>
                </div>
            </div>
            <!-- Card 3 -->
            <div class="glass p-6 rounded-xl hover:bg-slate-800/50 transition-colors">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-400 text-sm mb-1">Ventas Totales</p>
                        <h3 class="text-2xl font-bold text-white" x-text="formatCLP(stats.total_ventas)">$0</h3>
                    </div>
                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400">
                        <i class="ph ph-trend-up text-xl"></i>
                    </div>
                </div>
            </div>
            <!-- Card 4 -->
            <div class="glass p-6 rounded-xl hover:bg-slate-800/50 transition-colors">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-400 text-sm mb-1">DTE Pendientes</p>
                        <h3 class="text-2xl font-bold text-orange-400" x-text="stats.draft_dte">0</h3>
                    </div>
                    <div class="p-2 bg-orange-500/10 rounded-lg text-orange-400">
                        <i class="ph ph-warning-circle text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="flex-1 overflow-auto px-8 pb-8">
            <div class="glass rounded-xl overflow-hidden">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-slate-800/50 text-slate-200 uppercase text-xs font-semibold">
                        <tr>
                            <th class="px-6 py-4">ID</th>
                            <th class="px-6 py-4">Veh√≠culo</th>
                            <th class="px-6 py-4">Patente</th>
                            <th class="px-6 py-4 text-right">Precio Venta</th>
                            <th class="px-6 py-4 text-right">Comisi√≥n</th>
                            <th class="px-6 py-4 text-center">Estado</th>
                            <th class="px-6 py-4 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700">
                        <template x-for="car in cars" :key="car.id">
                            <tr class="hover:bg-slate-800/30 transition-colors group">
                                <td class="px-6 py-4 font-mono text-slate-500" x-text="car.id"></td>
                                <td class="px-6 py-4 font-medium text-white">
                                    <div x-text="car.brand + ' ' + car.model"></div>
                                    <div class="text-xs text-slate-500"
                                        x-text="(car.year || '') + ' ‚Ä¢ ' + (car.color || '')"></div>
                                </td>
                                <td class="px-6 py-4 font-mono">
                                    <span class="bg-slate-700 px-2 py-1 rounded text-white text-xs"
                                        x-text="car.patente"></span>
                                </td>
                                <td class="px-6 py-4 text-right text-white" x-text="formatCLP(car.selling_price)"></td>
                                <td class="px-6 py-4 text-right">
                                    <div class="text-green-400" x-text="formatCLP(car.commission_amount)"></div>
                                    <div class="text-xs" x-text="Math.round(car.commission_pct * 100) + '%'"></div>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <span :class="`badge badge-${car.status}`" x-text="formatStatus(car.status)"></span>
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <button @click="openDTEModal(car)"
                                        class="text-blue-400 hover:text-blue-300 font-medium text-xs px-3 py-1 rounded border border-blue-900 bg-blue-900/20 hover:bg-blue-900/40 transition-colors">
                                        <i class="ph ph-file-text mr-1"></i> DTE
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Funnels View (iframe) -->
    <div x-show="currentView==='funnels'" class="flex-1 flex flex-col overflow-hidden" style="display: none;">
        <header class="h-16 glass border-b border-slate-700 flex items-center justify-between px-8 shrink-0">
            <div class="flex items-center gap-3">
                <i class="ph ph-funnel text-xl text-green-400"></i>
                <h2 class="text-lg font-semibold text-white">FB Marketplace Funnels</h2>
                <span class="bg-green-500/20 text-green-400 text-xs px-2 py-0.5 rounded-full font-semibold">Live</span>
            </div>
            <a href="/funnels" target="_blank"
                class="text-slate-400 hover:text-white text-sm flex items-center gap-1 transition-colors">
                <i class="ph ph-arrow-square-out"></i> Abrir en nueva ventana
            </a>
        </header>
        <iframe src="/funnels" class="flex-1 w-full border-0" style="background: #0f172a;"></iframe>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- CRM View                                                               -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div x-show="currentView==='crm'" class="flex-1 flex flex-col overflow-hidden" style="display: none;">
        <!-- CRM Header -->
        <header class="h-16 glass border-b border-slate-700 flex items-center justify-between px-8 shrink-0">
            <div class="flex items-center gap-3">
                <i class="ph ph-address-book text-xl text-purple-400"></i>
                <h2 class="text-lg font-semibold text-white">CRM ‚Äî Gesti√≥n de Leads</h2>
                <span class="bg-purple-500/20 text-purple-400 text-xs px-2 py-0.5 rounded-full font-semibold"
                    x-text="crmLeads.length + ' leads'"></span>
            </div>
            <div class="flex items-center gap-3">
                <!-- View Toggle -->
                <div class="flex bg-slate-800 rounded-lg p-0.5">
                    <button @click="crmViewMode='kanban'"
                        :class="crmViewMode==='kanban' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'"
                        class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors">
                        <i class="ph ph-kanban mr-1"></i> Pipeline
                    </button>
                    <button @click="crmViewMode='table'"
                        :class="crmViewMode==='table' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'"
                        class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors">
                        <i class="ph ph-table mr-1"></i> Tabla
                    </button>
                </div>
                <!-- Search -->
                <div class="relative">
                    <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-500"></i>
                    <input type="text" x-model="crmSearch" @input.debounce.300ms="loadCRMLeads()"
                        placeholder="Buscar lead..."
                        class="bg-slate-800 border border-slate-600 rounded-lg pl-9 pr-3 py-2 text-white text-sm w-48 focus:outline-none focus:border-purple-500 focus:w-64 transition-all">
                </div>
                <!-- Import -->
                <div class="relative" x-data="{importOpen:false}">
                    <button @click="importOpen=!importOpen"
                        class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                        <i class="ph ph-download-simple"></i> Importar
                        <i class="ph ph-caret-down text-xs"></i>
                    </button>
                    <div x-show="importOpen" @click.away="importOpen=false"
                        class="absolute right-0 mt-2 w-56 glass rounded-xl shadow-2xl border border-slate-700 p-2 z-50"
                        style="display:none;">
                        <button @click="syncFromSupabase(); importOpen=false"
                            class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors flex items-center gap-2">
                            <i class="ph ph-cloud-arrow-down text-blue-400"></i> Sync Autodirecto
                        </button>
                        <button @click="importFromFunnels(); importOpen=false"
                            class="w-full text-left px-3 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors flex items-center gap-2">
                            <i class="ph ph-funnel text-green-400"></i> Importar Funnels
                        </button>
                    </div>
                </div>
                <!-- Add Lead -->
                <button @click="openCRMAddModal()"
                    class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <i class="ph ph-plus"></i> Nuevo Lead
                </button>
            </div>
        </header>

        <!-- CRM Stats Bar -->
        <div class="px-8 pt-5 pb-3 flex gap-3 overflow-x-auto shrink-0">
            <template x-for="st in crmStageOrder" :key="st">
                <button @click="crmFilterStage = crmFilterStage===st ? null : st; loadCRMLeads()"
                    :class="crmFilterStage===st ? crmStageColors[st].active : 'bg-slate-800/50 hover:bg-slate-800'"
                    class="flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all whitespace-nowrap border border-slate-700">
                    <span class="w-2.5 h-2.5 rounded-full" :class="crmStageColors[st].dot"></span>
                    <span :class="crmFilterStage===st ? 'text-white' : 'text-slate-300'"
                        x-text="crmStageLabels[st]"></span>
                    <span class="text-xs px-1.5 py-0.5 rounded-full bg-slate-700/50"
                        :class="crmFilterStage===st ? 'text-white' : 'text-slate-500'"
                        x-text="(crmStats.pipeline && crmStats.pipeline[st]) || 0"></span>
                </button>
            </template>
        </div>

        <!-- KANBAN VIEW -->
        <div x-show="crmViewMode==='kanban'" class="flex-1 overflow-x-auto px-8 pb-6">
            <div class="flex gap-4 h-full min-w-max">
                <template x-for="stage in crmStageOrder" :key="stage">
                    <div class="w-80 flex flex-col bg-slate-900/50 rounded-xl border border-slate-800 overflow-hidden"
                        @dragover.prevent @drop="handleCRMDrop($event, stage)">
                        <!-- Column Header -->
                        <div class="px-4 py-3 border-b border-slate-800 flex items-center justify-between shrink-0">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full" :class="crmStageColors[stage].dot"></span>
                                <span class="text-sm font-semibold text-white" x-text="crmStageLabels[stage]"></span>
                            </div>
                            <span class="text-xs text-slate-500 bg-slate-800 px-2 py-0.5 rounded-full"
                                x-text="crmLeads.filter(l => l.stage===stage).length"></span>
                        </div>
                        <!-- Cards -->
                        <div class="flex-1 overflow-y-auto p-3 space-y-3 min-h-0">
                            <template x-for="lead in crmLeads.filter(l => l.stage===stage)" :key="lead.id">
                                <div class="glass rounded-xl p-4 cursor-pointer hover:bg-slate-700/50 transition-all border border-transparent hover:border-purple-500/30 group"
                                    draggable="true" @dragstart="$event.dataTransfer.setData('text/plain', lead.id)"
                                    @click="openCRMDetail(lead.id)">
                                    <!-- Priority Indicator + Source -->
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-1.5">
                                            <span class="w-1.5 h-1.5 rounded-full"
                                                :class="{'bg-red-400': lead.priority==='high', 'bg-yellow-400': lead.priority==='medium', 'bg-slate-500': lead.priority==='low'}"></span>
                                            <span class="text-[10px] uppercase tracking-wider font-semibold"
                                                :class="{'text-blue-400': lead.source==='autodirecto', 'text-green-400': lead.source==='funnels', 'text-slate-500': lead.source==='manual'}"
                                                x-text="lead.source || 'manual'"></span>
                                        </div>
                                        <span class="text-[10px] text-slate-600 font-mono"
                                            x-text="'#' + lead.id"></span>
                                    </div>
                                    <!-- Name -->
                                    <h4 class="text-sm font-semibold text-white truncate mb-1"
                                        x-text="lead.full_name || (lead.first_name ? lead.first_name + ' ' + (lead.last_name || '') : 'Sin nombre')">
                                    </h4>
                                    <!-- Vehicle -->
                                    <div x-show="lead.car_make || lead.plate" class="flex items-center gap-1.5 mb-2">
                                        <i class="ph ph-car-simple text-slate-500 text-xs"></i>
                                        <span class="text-xs text-slate-400 truncate"
                                            x-text="[lead.car_make, lead.car_model, lead.car_year].filter(Boolean).join(' ') || lead.plate"></span>
                                        <span x-show="lead.plate"
                                            class="text-[10px] bg-slate-700 px-1.5 py-0.5 rounded text-slate-300 font-mono"
                                            x-text="lead.plate"></span>
                                    </div>
                                    <!-- Bottom info -->
                                    <div class="flex items-center justify-between mt-2 pt-2 border-t border-slate-800">
                                        <div class="flex items-center gap-2">
                                            <span x-show="lead.phone"
                                                class="text-[10px] text-slate-500 flex items-center gap-0.5">
                                                <i class="ph ph-phone"></i>
                                                <span x-text="lead.phone"></span>
                                            </span>
                                        </div>
                                        <span x-show="lead.appointment_date"
                                            class="text-[10px] text-purple-400 flex items-center gap-0.5">
                                            <i class="ph ph-calendar"></i>
                                            <span x-text="lead.appointment_date"></span>
                                        </span>
                                    </div>
                                </div>
                            </template>
                            <!-- Empty state -->
                            <div x-show="crmLeads.filter(l => l.stage===stage).length === 0"
                                class="text-center py-8 text-slate-600">
                                <i class="ph ph-tray text-2xl mb-2 block"></i>
                                <p class="text-xs">Sin leads</p>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- TABLE VIEW -->
        <div x-show="crmViewMode==='table'" class="flex-1 overflow-auto px-8 pb-6">
            <div class="glass rounded-xl overflow-hidden">
                <table class="w-full text-left text-sm text-slate-400">
                    <thead class="bg-slate-800/50 text-slate-200 uppercase text-xs font-semibold sticky top-0">
                        <tr>
                            <th class="px-4 py-3">ID</th>
                            <th class="px-4 py-3">Lead</th>
                            <th class="px-4 py-3">Contacto</th>
                            <th class="px-4 py-3">Veh√≠culo</th>
                            <th class="px-4 py-3">Cita</th>
                            <th class="px-4 py-3 text-center">Etapa</th>
                            <th class="px-4 py-3 text-center">Fuente</th>
                            <th class="px-4 py-3">Creado</th>
                            <th class="px-4 py-3 text-right">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-700">
                        <template x-for="lead in crmLeads" :key="lead.id">
                            <tr class="hover:bg-slate-800/30 transition-colors cursor-pointer"
                                @click="openCRMDetail(lead.id)">
                                <td class="px-4 py-3 font-mono text-slate-500 text-xs" x-text="lead.id"></td>
                                <td class="px-4 py-3">
                                    <div class="font-medium text-white text-sm"
                                        x-text="lead.full_name || (lead.first_name ? lead.first_name + ' ' + (lead.last_name || '') : 'Sin nombre')">
                                    </div>
                                    <div x-show="lead.rut" class="text-xs text-slate-500" x-text="lead.rut"></div>
                                </td>
                                <td class="px-4 py-3">
                                    <div x-show="lead.phone" class="text-xs flex items-center gap-1">
                                        <i class="ph ph-phone text-slate-500"></i>
                                        <span x-text="(lead.country_code || '') + ' ' + (lead.phone || '')"></span>
                                    </div>
                                    <div x-show="lead.email" class="text-xs flex items-center gap-1">
                                        <i class="ph ph-envelope text-slate-500"></i>
                                        <span x-text="lead.email" class="truncate max-w-[150px]"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <div class="text-sm text-white"
                                        x-text="[lead.car_make, lead.car_model, lead.car_year].filter(Boolean).join(' ') || '-'">
                                    </div>
                                    <div x-show="lead.plate" class="mt-0.5">
                                        <span
                                            class="text-[10px] bg-slate-700 px-1.5 py-0.5 rounded font-mono text-slate-300"
                                            x-text="lead.plate"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3">
                                    <span x-show="lead.appointment_date" class="text-xs text-purple-400"
                                        x-text="lead.appointment_date + (lead.appointment_time ? ' ' + lead.appointment_time : '')"></span>
                                    <span x-show="!lead.appointment_date" class="text-xs text-slate-600">‚Äî</span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="text-xs px-2.5 py-1 rounded-full font-semibold"
                                        :class="crmStageColors[lead.stage]?.badge || 'bg-slate-700 text-slate-300'"
                                        x-text="crmStageLabels[lead.stage] || lead.stage"></span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="text-xs px-2 py-0.5 rounded-full font-medium"
                                        :class="{'bg-blue-500/20 text-blue-400': lead.source==='autodirecto', 'bg-green-500/20 text-green-400': lead.source==='funnels', 'bg-slate-700 text-slate-400': lead.source==='manual'}"
                                        x-text="lead.source || 'manual'"></span>
                                </td>
                                <td class="px-4 py-3 text-xs text-slate-500" x-text="formatDate(lead.created_at)"></td>
                                <td class="px-4 py-3 text-right">
                                    <button @click.stop="openCRMDetail(lead.id)"
                                        class="text-purple-400 hover:text-purple-300 text-xs px-2 py-1 rounded border border-purple-900 bg-purple-900/20 hover:bg-purple-900/40 transition-colors">
                                        <i class="ph ph-eye mr-0.5"></i> Ver
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <!-- Empty state -->
                <div x-show="crmLeads.length === 0" class="text-center py-16 text-slate-500">
                    <i class="ph ph-address-book text-4xl mb-3 block"></i>
                    <p class="text-sm font-medium mb-1">Sin leads a√∫n</p>
                    <p class="text-xs text-slate-600">Importa desde Autodirecto o Funnels para empezar</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- CRM: Lead Detail Side Panel                                            -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div x-show="crmDetailOpen" class="fixed inset-0 z-50 flex justify-end bg-black/60 backdrop-blur-sm"
        @click.self="crmDetailOpen=false" style="display:none;">
        <div class="w-full max-w-xl bg-slate-900 border-l border-slate-700 h-full flex flex-col overflow-hidden shadow-2xl"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-full"
            x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in duration-200"
            x-transition:leave-start="translate-x-0" x-transition:leave-end="translate-x-full">
            <!-- Detail Header -->
            <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-500 to-blue-500 flex items-center justify-center text-white text-sm font-bold"
                        x-text="crmDetail?.full_name ? crmDetail.full_name.charAt(0).toUpperCase() : '?'"></div>
                    <div>
                        <h3 class="text-white font-semibold" x-text="crmDetail?.full_name || 'Sin nombre'"></h3>
                        <p class="text-xs text-slate-500" x-text="'Lead #' + (crmDetail?.id || '')"></p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button @click="deleteCRMLead(crmDetail.id)"
                        class="text-red-400 hover:text-red-300 p-2 rounded-lg hover:bg-red-900/20 transition-colors">
                        <i class="ph ph-trash text-lg"></i>
                    </button>
                    <button @click="crmDetailOpen=false"
                        class="text-slate-400 hover:text-white p-2 rounded-lg hover:bg-slate-800 transition-colors">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                </div>
            </div>
            <!-- Detail Body (scrollable) -->
            <div class="flex-1 overflow-y-auto">
                <!-- Stage Selector -->
                <div class="px-6 py-4 border-b border-slate-800">
                    <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-2 block">Etapa del
                        Pipeline</label>
                    <div class="flex flex-wrap gap-1.5">
                        <template x-for="st in crmStageOrder" :key="st">
                            <button @click="updateCRMLeadStage(crmDetail.id, st)"
                                :class="crmDetail?.stage===st ? crmStageColors[st].active + ' ring-1 ring-white/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'"
                                class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all">
                                <span x-text="crmStageLabels[st]"></span>
                            </button>
                        </template>
                    </div>
                </div>
                <!-- Contact Info -->
                <div class="px-6 py-4 border-b border-slate-800">
                    <h4 class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-3">Contacto</h4>
                    <div class="space-y-2.5">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-identification-card text-slate-500 w-5 text-center"></i>
                            <span class="text-sm text-white" x-text="crmDetail?.rut || '‚Äî'"></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="ph ph-phone text-slate-500 w-5 text-center"></i>
                            <span class="text-sm text-white"
                                x-text="crmDetail?.phone ? (crmDetail.country_code || '+56') + ' ' + crmDetail.phone : '‚Äî'"></span>
                            <a x-show="crmDetail?.phone"
                                :href="'https://wa.me/' + (crmDetail?.country_code || '+56').replace('+','') + crmDetail?.phone"
                                target="_blank" class="text-green-400 hover:text-green-300 text-xs">
                                <i class="ph ph-whatsapp-logo"></i>
                            </a>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="ph ph-envelope text-slate-500 w-5 text-center"></i>
                            <span class="text-sm text-white" x-text="crmDetail?.email || '‚Äî'"></span>
                        </div>
                        <div class="flex items-center gap-3">
                            <i class="ph ph-map-pin text-slate-500 w-5 text-center"></i>
                            <span class="text-sm text-white"
                                x-text="[crmDetail?.address, crmDetail?.commune, crmDetail?.region].filter(Boolean).join(', ') || '‚Äî'"></span>
                        </div>
                    </div>
                </div>
                <!-- Vehicle Info -->
                <div class="px-6 py-4 border-b border-slate-800">
                    <h4 class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-3">Veh√≠culo</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <p class="text-[10px] text-slate-500 uppercase mb-0.5">Marca / Modelo</p>
                            <p class="text-sm text-white font-medium"
                                x-text="[crmDetail?.car_make, crmDetail?.car_model].filter(Boolean).join(' ') || '‚Äî'">
                            </p>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <p class="text-[10px] text-slate-500 uppercase mb-0.5">A√±o</p>
                            <p class="text-sm text-white font-medium" x-text="crmDetail?.car_year || '‚Äî'"></p>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <p class="text-[10px] text-slate-500 uppercase mb-0.5">Patente</p>
                            <p class="text-sm text-white font-mono" x-text="crmDetail?.plate || '‚Äî'"></p>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-3">
                            <p class="text-[10px] text-slate-500 uppercase mb-0.5">Kilometraje</p>
                            <p class="text-sm text-white"
                                x-text="crmDetail?.mileage ? crmDetail.mileage.toLocaleString('es-CL') + ' km' : '‚Äî'">
                            </p>
                        </div>
                    </div>
                    <!-- Pricing Breakdown -->
                    <div x-show="crmDetail?.estimated_value || crmDetail?.listing_price || crmDetail?.ai_consignacion_price"
                        class="mt-3 space-y-2">
                        <!-- Row 1: Owner's original listing price -->
                        <div x-show="crmDetail?.listing_price"
                            class="bg-slate-800/50 rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] text-slate-500 uppercase mb-0.5">Publicaci√≥n de Due√±o</p>
                                <p class="text-[9px] text-slate-600">Precio que el due√±o pide en FB</p>
                            </div>
                            <p class="text-sm text-slate-300 font-medium" x-text="formatCLP(crmDetail.listing_price)">
                            </p>
                        </div>
                        <!-- Row 2: AI Market Price = what we publish & sell for (contrato de VENTA) -->
                        <div x-show="crmDetail?.estimated_value"
                            class="bg-green-500/10 border border-green-500/20 rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] text-green-400 uppercase font-bold mb-0.5">üí∞ Precio a Vender</p>
                                <p class="text-[9px] text-green-600">Se publica en la p√°gina ¬∑ Contrato de Venta</p>
                            </div>
                            <p class="text-base text-green-400 font-bold" x-text="formatCLP(crmDetail.estimated_value)">
                            </p>
                        </div>
                        <!-- Row 3: Consignaci√≥n price = what owner gets (contrato de consignaci√≥n) -->
                        <div x-show="crmDetail?.ai_consignacion_price"
                            class="bg-blue-500/10 border border-blue-500/20 rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <p class="text-[10px] text-blue-400 uppercase font-bold mb-0.5">ü§ù Precio Consignaci√≥n
                                </p>
                                <p class="text-[9px] text-blue-600">Monto que recibe el due√±o ¬∑ Contrato de Consignaci√≥n
                                </p>
                            </div>
                            <p class="text-base text-blue-400 font-bold"
                                x-text="formatCLP(crmDetail.ai_consignacion_price)"></p>
                        </div>
                        <!-- Commission math helper -->
                        <div x-show="crmDetail?.estimated_value && crmDetail?.ai_consignacion_price"
                            class="bg-slate-800/30 rounded-lg p-2 text-[10px] text-slate-500 leading-relaxed">
                            <span class="font-bold text-slate-400">üìä Comisi√≥n Mr. Car:</span>
                            <span
                                x-text="formatCLP((crmDetail?.estimated_value || 0) - (crmDetail?.ai_consignacion_price || 0))"></span>
                            <span class="mx-1">¬∑</span>
                            <span
                                x-text="((((crmDetail?.estimated_value || 0) - (crmDetail?.ai_consignacion_price || 0)) / (crmDetail?.estimated_value || 1)) * 100).toFixed(1) + '%'"></span>
                            <span class="block mt-0.5 text-slate-600">Precio a Vender ‚àí Consignaci√≥n = Comisi√≥n</span>
                        </div>
                    </div>
                </div>
                <!-- Appointment Info -->
                <div x-show="crmDetail?.appointment_date" class="px-6 py-4 border-b border-slate-800">
                    <h4 class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-3">Cita Programada</h4>
                    <div class="bg-purple-500/10 border border-purple-500/20 rounded-lg p-4 flex items-center gap-4">
                        <div class="w-12 h-12 bg-purple-600/20 rounded-lg flex items-center justify-center">
                            <i class="ph ph-calendar-check text-2xl text-purple-400"></i>
                        </div>
                        <div>
                            <p class="text-white font-semibold" x-text="crmDetail?.appointment_date"></p>
                            <p class="text-purple-400 text-sm"
                                x-text="crmDetail?.appointment_time ? 'Hora: ' + crmDetail.appointment_time : 'Sin hora definida'">
                            </p>
                        </div>
                    </div>
                </div>
                <!-- Quick Actions -->
                <div class="px-6 py-4 border-b border-slate-800">
                    <h4 class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-3">Acciones R√°pidas</h4>
                    <div class="grid grid-cols-4 gap-2">
                        <button @click="addCRMActivity(crmDetail.id, 'call', 'Llamada realizada')"
                            class="flex flex-col items-center gap-1 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
                            <i class="ph ph-phone-call text-blue-400"></i>
                            <span class="text-[10px] text-slate-400">Llamar</span>
                        </button>
                        <button @click="addCRMActivity(crmDetail.id, 'whatsapp', 'Mensaje WhatsApp enviado')"
                            class="flex flex-col items-center gap-1 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
                            <i class="ph ph-whatsapp-logo text-green-400"></i>
                            <span class="text-[10px] text-slate-400">WhatsApp</span>
                        </button>
                        <button @click="addCRMActivity(crmDetail.id, 'email', 'Email enviado')"
                            class="flex flex-col items-center gap-1 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
                            <i class="ph ph-envelope text-orange-400"></i>
                            <span class="text-[10px] text-slate-400">Email</span>
                        </button>
                        <button @click="addCRMActivity(crmDetail.id, 'meeting', 'Reuni√≥n agendada')"
                            class="flex flex-col items-center gap-1 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 transition-colors">
                            <i class="ph ph-video-camera text-purple-400"></i>
                            <span class="text-[10px] text-slate-400">Reuni√≥n</span>
                        </button>
                    </div>
                </div>
                <!-- Notes -->
                <div class="px-6 py-4 border-b border-slate-800">
                    <h4 class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-2">Notas</h4>
                    <textarea x-model="crmDetailNotes" @change="saveCRMNotes(crmDetail.id)" rows="3"
                        placeholder="Agregar nota sobre este lead..."
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-purple-500 resize-none"></textarea>
                </div>
                <!-- Activity Timeline -->
                <div class="px-6 py-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-xs text-slate-500 uppercase tracking-wider font-semibold">Historial de Actividad
                        </h4>
                        <button @click="addCRMNoteModal=true"
                            class="text-xs text-purple-400 hover:text-purple-300 flex items-center gap-1 transition-colors">
                            <i class="ph ph-plus"></i> Nota
                        </button>
                    </div>
                    <!-- Add note inline -->
                    <div x-show="addCRMNoteModal" class="mb-4 bg-slate-800/50 rounded-lg p-3 border border-slate-700">
                        <input type="text" x-model="newCRMNoteTitle" placeholder="T√≠tulo de la nota..."
                            class="w-full bg-transparent border-0 text-white text-sm focus:outline-none mb-2 placeholder:text-slate-600">
                        <textarea x-model="newCRMNoteDesc" placeholder="Descripci√≥n (opcional)..." rows="2"
                            class="w-full bg-transparent border-0 text-slate-400 text-xs focus:outline-none resize-none placeholder:text-slate-600"></textarea>
                        <div class="flex justify-end gap-2 mt-2">
                            <button @click="addCRMNoteModal=false; newCRMNoteTitle=''; newCRMNoteDesc=''"
                                class="text-xs text-slate-400 hover:text-white px-3 py-1 transition-colors">Cancelar</button>
                            <button @click="submitCRMNote(crmDetail.id)"
                                class="text-xs bg-purple-600 hover:bg-purple-500 text-white px-3 py-1 rounded-md transition-colors">Guardar</button>
                        </div>
                    </div>
                    <!-- Timeline -->
                    <div class="space-y-0 relative">
                        <div class="absolute left-[9px] top-2 bottom-2 w-px bg-slate-800"></div>
                        <template x-for="act in (crmDetail?.activities || [])" :key="act.id">
                            <div class="flex gap-3 py-2 relative">
                                <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center shrink-0 mt-0.5 z-10"
                                    :class="{
                                        'border-blue-500 bg-blue-500/20': act.type==='call',
                                        'border-green-500 bg-green-500/20': act.type==='whatsapp',
                                        'border-orange-500 bg-orange-500/20': act.type==='email',
                                        'border-purple-500 bg-purple-500/20': act.type==='meeting' || act.type==='stage_change',
                                        'border-cyan-500 bg-cyan-500/20': act.type==='imported',
                                        'border-slate-600 bg-slate-800': act.type==='note' || act.type==='created'
                                    }">
                                    <i class="text-[8px]" :class="{
                                            'ph ph-phone text-blue-400': act.type==='call',
                                            'ph ph-whatsapp-logo text-green-400': act.type==='whatsapp',
                                            'ph ph-envelope text-orange-400': act.type==='email',
                                            'ph ph-video-camera text-purple-400': act.type==='meeting',
                                            'ph ph-arrows-left-right text-purple-400': act.type==='stage_change',
                                            'ph ph-download text-cyan-400': act.type==='imported',
                                            'ph ph-note text-slate-400': act.type==='note',
                                            'ph ph-plus text-slate-400': act.type==='created'
                                        }"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm text-white" x-text="act.title"></p>
                                    <p x-show="act.description" class="text-xs text-slate-500 mt-0.5"
                                        x-text="act.description"></p>
                                    <p class="text-[10px] text-slate-600 mt-1" x-text="formatDate(act.created_at)"></p>
                                </div>
                            </div>
                        </template>
                        <div x-show="!crmDetail?.activities || crmDetail.activities.length === 0"
                            class="text-center py-6 text-slate-600 text-xs">Sin actividad registrada</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- CALENDAR VIEW                                                          -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div x-show="currentView==='calendar'" class="flex-1 flex flex-col overflow-hidden" style="display:none;">
        <header class="h-16 glass border-b border-slate-700 flex items-center justify-between px-8 shrink-0">
            <div class="flex items-center gap-3">
                <i class="ph ph-calendar-dots text-xl text-cyan-400"></i>
                <h2 class="text-lg font-semibold text-white">Calendario de Citas</h2>
                <span class="bg-cyan-500/20 text-cyan-400 text-xs px-2 py-0.5 rounded-full"
                    x-text="calEvents.length + ' citas'"></span>
            </div>
            <div class="flex items-center gap-3">
                <!-- Month nav -->
                <button @click="calPrevMonth()"
                    class="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-colors">
                    <i class="ph ph-caret-left"></i>
                </button>
                <span class="text-white font-semibold w-36 text-center" x-text="calMonthLabel"></span>
                <button @click="calNextMonth()"
                    class="p-2 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-colors">
                    <i class="ph ph-caret-right"></i>
                </button>
                <button @click="loadCalendar()"
                    class="text-slate-400 hover:text-white p-2 rounded-lg hover:bg-slate-700 transition-colors">
                    <i class="ph ph-arrows-clockwise"></i>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Calendar Grid -->
            <div class="flex-1 flex flex-col overflow-hidden p-6">
                <!-- Day headers -->
                <div class="grid grid-cols-7 gap-1 mb-1">
                    <template x-for="d in ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom']">
                        <div class="text-center text-xs font-semibold text-slate-500 py-2" x-text="d"></div>
                    </template>
                </div>
                <!-- Day cells -->
                <div class="grid grid-cols-7 gap-1 flex-1 overflow-hidden">
                    <template x-for="(cell, idx) in calGrid" :key="idx">
                        <div class="min-h-0 rounded-lg p-1 text-xs flex flex-col transition-colors cursor-pointer"
                            :class="cell.isToday ? 'bg-cyan-500/10 border border-cyan-500/30' : cell.date ? 'hover:bg-slate-800/50' : 'opacity-20'"
                            @click="cell.date && selectCalDay(cell.date)">
                            <!-- Day number -->
                            <div class="flex items-center justify-between mb-0.5 px-1">
                                <span :class="cell.isToday ? 'text-cyan-400 font-bold' : 'text-slate-400'"
                                    x-text="cell.day || ''"></span>
                                <span x-show="cell.events && cell.events.length > 0"
                                    class="text-[9px] bg-cyan-500/20 text-cyan-400 rounded-full px-1 font-semibold"
                                    x-text="cell.events.length"></span>
                            </div>
                            <!-- Event chips -->
                            <div class="overflow-hidden flex-1 space-y-0.5">
                                <template x-for="(ev, ei) in (cell.events || []).slice(0,3)" :key="ei">
                                    <div class="px-1.5 py-0.5 rounded text-[10px] font-medium truncate cursor-pointer"
                                        :class="ev.assigned_user ? 'text-white' : 'bg-cyan-900/40 text-cyan-300'"
                                        :style="ev.assigned_user ? 'background:' + (ev.assigned_user.color || '#3b82f6') + '33; color:' + (ev.assigned_user.color || '#3b82f6') : ''"
                                        @click.stop="openCalEvent(ev)"
                                        x-text="(ev.appointment_time || '') + ' ' + (ev.full_name || ev.plate || 'Cita')">
                                    </div>
                                </template>
                                <div x-show="(cell.events || []).length > 3" class="text-[9px] text-slate-500 px-1"
                                    x-text="'+' + ((cell.events||[]).length-3) + ' m√°s'"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Day Detail Panel (right sidebar) -->
            <div class="w-80 border-l border-slate-700 flex flex-col overflow-hidden shrink-0">
                <div class="px-5 py-4 border-b border-slate-700">
                    <h3 class="text-sm font-semibold text-white"
                        x-text="calSelectedDay ? calSelectedDayLabel : 'Selecciona un d√≠a'"></h3>
                    <p class="text-xs text-slate-500 mt-0.5" x-text="calSelectedDayEvents.length + ' citas'"></p>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3">
                    <div x-show="!calSelectedDay" class="text-center py-12 text-slate-600">
                        <i class="ph ph-calendar-blank text-3xl block mb-2"></i>
                        <p class="text-xs">Haz click en un d√≠a para ver las citas</p>
                    </div>
                    <template x-for="ev in calSelectedDayEvents" :key="ev.id">
                        <div class="glass rounded-xl p-4 border border-slate-700 hover:border-cyan-500/30 transition-colors cursor-pointer"
                            @click="openCalEvent(ev)">
                            <!-- Time + status -->
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-cyan-400 text-xs font-mono"
                                    x-text="ev.appointment_time || 'Sin hora'"></span>
                                <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold"
                                    :class="ev.status==='agendado' ? 'bg-cyan-500/20 text-cyan-400' : 'bg-slate-700 text-slate-400'"
                                    x-text="ev.status || 'agendado'"></span>
                            </div>
                            <!-- Name -->
                            <p class="text-sm font-medium text-white mb-1" x-text="ev.full_name || 'Sin nombre'"></p>
                            <!-- Vehicle -->
                            <p class="text-xs text-slate-400"
                                x-text="[ev.car_make, ev.car_model, ev.car_year].filter(Boolean).join(' ') + (ev.plate ? ' ¬∑ ' + ev.plate : '')">
                            </p>
                            <!-- Assigned -->
                            <div class="flex items-center justify-between mt-3 pt-2 border-t border-slate-800">
                                <div x-show="ev.assigned_user" class="flex items-center gap-1.5">
                                    <div class="w-5 h-5 rounded-full flex items-center justify-center text-[9px] font-bold text-white"
                                        :style="'background:' + (ev.assigned_user?.color || '#3b82f6')">
                                        <span x-text="ev.assigned_user?.name?.charAt(0) || '?'"></span>
                                    </div>
                                    <span class="text-xs text-slate-400" x-text="ev.assigned_user?.name"></span>
                                </div>
                                <span x-show="!ev.assigned_user" class="text-xs text-slate-600">Sin asignar</span>
                                <span class="text-[10px] px-1.5 py-0.5 rounded text-slate-400"
                                    :class="ev.consignacion_status === 'sin_consignacion' ? 'bg-slate-800' : 'bg-amber-500/20 text-amber-400'"
                                    x-text="ev.consignacion_status === 'sin_consignacion' ? 'Sin consig.' : ev.consignacion_status"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Event Modal -->
    <div x-show="calEventOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm"
        @click.self="calEventOpen=false" style="display:none;">
        <div class="glass w-full max-w-lg rounded-2xl p-6 shadow-2xl border border-slate-700">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-white font-semibold text-lg" x-text="calActiveEvent?.full_name || 'Cita'"></h3>
                <button @click="calEventOpen=false"
                    class="text-slate-400 hover:text-white p-1 rounded-lg hover:bg-slate-800 transition-colors">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <!-- Info -->
            <div class="grid grid-cols-2 gap-3 mb-5">
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-[10px] text-slate-500 uppercase mb-0.5">Fecha y Hora</p>
                    <p class="text-sm text-white font-medium"
                        x-text="(calActiveEvent?.appointment_date || '') + ' ' + (calActiveEvent?.appointment_time || '')">
                    </p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-[10px] text-slate-500 uppercase mb-0.5">Veh√≠culo</p>
                    <p class="text-sm text-white font-medium"
                        x-text="[calActiveEvent?.car_make, calActiveEvent?.car_model, calActiveEvent?.car_year].filter(Boolean).join(' ') || '‚Äî'">
                    </p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-[10px] text-slate-500 uppercase mb-0.5">Patente</p>
                    <p class="text-sm text-white font-mono" x-text="calActiveEvent?.plate || '‚Äî'"></p>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-3">
                    <p class="text-[10px] text-slate-500 uppercase mb-0.5">Tel√©fono</p>
                    <p class="text-sm text-white" x-text="calActiveEvent?.phone || '‚Äî'"></p>
                </div>
            </div>
            <!-- Assign User -->
            <div class="mb-5">
                <label class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-2 block">Asignar
                    a</label>
                <div class="flex flex-wrap gap-2">
                    <button @click="calAssignUser(calActiveEvent, null)"
                        :class="!calActiveEvent?.assigned_user_id ? 'bg-slate-600 text-white ring-1 ring-white/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all">Sin asignar</button>
                    <template x-for="u in calUsers" :key="u.id">
                        <button @click="calAssignUser(calActiveEvent, u.id)"
                            :class="calActiveEvent?.assigned_user_id===u.id ? 'ring-1 ring-white/30 text-white' : 'text-slate-400 hover:text-white'"
                            :style="calActiveEvent?.assigned_user_id===u.id ? 'background:' + u.color + '44; border-color:' + u.color : ''"
                            class="px-3 py-1.5 rounded-lg text-xs font-medium transition-all bg-slate-800 hover:bg-slate-700 flex items-center gap-1.5">
                            <span class="w-3 h-3 rounded-full" :style="'background:' + u.color"></span>
                            <span x-text="u.name"></span>
                        </button>
                    </template>
                </div>
            </div>
            <!-- Funnels Match Suggestions -->
            <div x-show="calActiveEvent?.matched_funnel_leads?.length > 0"
                class="mt-4 bg-slate-800/30 rounded-xl p-4 border border-slate-700">
                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-1">
                    <i class="ph ph-intersect text-cyan-400"></i> Posibles coincidencias en Funnels
                </p>
                <div class="space-y-2">
                    <template x-for="m in calActiveEvent.matched_funnel_leads" :key="m.id">
                        <a :href="m.funnel_url" target="_blank"
                            class="flex items-center justify-between p-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors group">
                            <div>
                                <p class="text-xs text-white font-medium"
                                    x-text="[m.car_make, m.car_model, m.car_year].filter(Boolean).join(' ')"></p>
                                <p class="text-[10px] text-slate-500"
                                    x-text="(m.mileage ? m.mileage.toLocaleString('es-CL') + ' km' : '') + (m.listing_price ? ' ¬∑ $' + m.listing_price.toLocaleString('es-CL') : '')">
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] px-2 py-0.5 rounded-full font-bold"
                                    :class="m.score >= 100 ? 'bg-green-500/20 text-green-400' : 'bg-amber-500/20 text-amber-400'"
                                    x-text="m.score + '% match'"></span>
                                <i
                                    class="ph ph-arrow-square-out text-slate-500 group-hover:text-cyan-400 transition-colors text-sm"></i>
                            </div>
                        </a>
                    </template>
                </div>
            </div>
            <!-- Consignaci√≥n status -->
            <div class="bg-slate-800/30 rounded-xl p-4 border border-slate-700 mt-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 uppercase tracking-wider font-semibold mb-1">Consignaci√≥n</p>
                        <p class="text-sm text-white"
                            x-text="calActiveEvent?.consignacion_status === 'sin_consignacion' ? 'No creada a√∫n' : calActiveEvent?.consignacion_status">
                        </p>
                    </div>
                    <button x-show="calActiveEvent?.consignacion_id"
                        @click="calEventOpen=false; currentView='consignaciones'; loadConsignaciones(); setTimeout(()=>openConsignacion(calActiveEvent.consignacion_id),300)"
                        class="bg-amber-600/20 hover:bg-amber-600/40 text-amber-400 text-xs px-3 py-1.5 rounded-lg transition-colors">
                        <i class="ph ph-arrow-right mr-1"></i> Ver consignaci√≥n
                    </button>
                    <button x-show="!calActiveEvent?.consignacion_id && calActiveEvent?.assigned_user_id"
                        @click="calCreateConsignacion(calActiveEvent)"
                        class="bg-amber-600 hover:bg-amber-500 text-white text-xs px-3 py-1.5 rounded-lg transition-colors">
                        <i class="ph ph-plus mr-1"></i> Crear consignaci√≥n
                    </button>
                    <span x-show="!calActiveEvent?.consignacion_id && !calActiveEvent?.assigned_user_id"
                        class="text-xs text-slate-600">Asigna un usuario primero</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- CONSIGNACIONES VIEW                                                    -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- ‚ïê‚ïê‚ïê INSPECTION VIEWER OVERLAY ‚ïê‚ïê‚ïê -->
    <div x-show="inspViewOpen"
        class="fixed inset-0 z-[85] bg-slate-950/95 backdrop-blur-sm flex flex-col overflow-hidden"
        style="display:none;" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100">
        <!-- Top bar -->
        <div class="h-14 flex-shrink-0 bg-slate-900 border-b border-slate-800 flex items-center px-6 gap-4">
            <button @click="inspViewOpen=false"
                class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm">
                <i class="ph ph-arrow-left text-lg"></i> Volver
            </button>
            <div class="flex-1 flex items-center gap-2">
                <i class="ph ph-file-text text-green-400"></i>
                <span class="text-white font-semibold text-sm">Informe de Inspecci√≥n</span>
                <span class="text-green-400 text-sm font-mono"
                    x-text="inspViewData?.appraisal?.vehicle_marca + ' ' + inspViewData?.appraisal?.vehicle_modelo + ' ¬∑ ' + (inspViewData?.appraisal?.vehicle_patente||'').toUpperCase()"></span>
            </div>
            <!-- Action buttons -->
            <div class="flex items-center gap-2">
                <!-- Print / PDF -->
                <a :href="'/api/inspecciones/' + inspViewId + '/pdf'" target="_blank"
                    class="flex items-center gap-1 bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors">
                    <i class="ph ph-printer text-sm"></i> Imprimir / PDF
                </a>
                <!-- Send email -->
                <button @click="inspEmailOpen=true"
                    class="flex items-center gap-1 bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors">
                    <i class="ph ph-envelope text-sm"></i> Enviar por Email
                </button>
            </div>
        </div>

        <!-- Report content (iframe of the PDF/HTML endpoint) -->
        <div class="flex-1 overflow-hidden relative">
            <div x-show="inspViewLoading" class="absolute inset-0 flex items-center justify-center bg-slate-950">
                <div class="text-center">
                    <i class="ph ph-spinner animate-spin text-4xl text-amber-400"></i>
                    <p class="text-slate-400 text-sm mt-3">Cargando informe...</p>
                </div>
            </div>
            <iframe x-show="!inspViewLoading" :src="inspViewId ? '/api/inspecciones/' + inspViewId + '/pdf' : ''"
                @load="inspViewLoading=false" class="w-full h-full border-0" style="background:#0f172a;"></iframe>
        </div>

        <!-- Email send modal -->
        <div x-show="inspEmailOpen"
            class="fixed inset-0 z-[95] flex items-center justify-center bg-black/70 backdrop-blur-sm"
            style="display:none;">
            <div class="glass w-full max-w-md rounded-2xl p-6 shadow-2xl" @click.away="inspEmailOpen=false">
                <h3 class="text-lg font-bold text-white mb-1 flex items-center gap-2">
                    <i class="ph ph-envelope text-blue-400"></i> Enviar Inspecci√≥n
                </h3>
                <p class="text-xs text-slate-400 mb-4">Se enviar√° el informe completo como email HTML desde
                    inspeccion@autochile.cl</p>

                <div class="space-y-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Destinatario *</label>
                        <input type="email" x-model="inspEmailTo" placeholder="cliente@email.com"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">CC (opcional)</label>
                        <input type="email" x-model="inspEmailCc" placeholder="copia@email.com"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Asunto</label>
                        <input type="text" x-model="inspEmailSubject" placeholder="Se genera autom√°ticamente"
                            class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <div class="flex gap-2 mt-5">
                    <button @click="inspEmailOpen=false"
                        class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                        Cancelar
                    </button>
                    <button @click="sendInspEmail()" :disabled="inspEmailSending || !inspEmailTo"
                        class="flex-1 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white py-2 rounded-lg text-sm font-semibold transition-colors flex items-center justify-center gap-2">
                        <span x-show="!inspEmailSending"><i class="ph ph-paper-plane-tilt"></i> Enviar</span>
                        <span x-show="inspEmailSending" style="display:none;"><i class="ph ph-spinner animate-spin"></i>
                            Enviando...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- ‚ïê‚ïê‚ïê CONTRACT SIGNING OVERLAY ‚ïê‚ïê‚ïê -->
    <div x-show="contractOpen"
        class="fixed inset-0 z-[95] bg-slate-950/98 backdrop-blur-sm flex flex-col overflow-hidden"
        style="display:none;" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100">
        <!-- Top bar -->
        <div class="h-14 flex-shrink-0 bg-slate-900 border-b border-slate-800 flex items-center px-6 gap-4">
            <button @click="contractOpen=false"
                class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm">
                <i class="ph ph-arrow-left text-lg"></i> Volver
            </button>
            <div class="flex-1 flex items-center gap-2">
                <i class="ph ph-file-text text-amber-400"></i>
                <span class="text-white font-semibold text-sm">Contrato de Consignaci√≥n</span>
                <span class="text-amber-400 text-sm font-mono" x-text="contractPlate"></span>
            </div>
            <div class="flex items-center gap-2">
                <a :href="contractSigned ? '/api/consignaciones/' + contractConsigId + '/contrato/descargar' : '/api/consignaciones/' + contractConsigId + '/contrato'"
                    target="_blank"
                    class="flex items-center gap-1 bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors">
                    <i class="ph ph-download text-sm"></i> Descargar PDF
                </a>
                <span x-show="contractSigned"
                    class="flex items-center gap-1 bg-green-600/20 text-green-400 px-3 py-1.5 rounded-lg text-xs font-semibold">
                    <i class="ph ph-check-circle"></i> Firmado ‚úì
                </span>
            </div>
        </div>

        <div class="flex-1 flex overflow-hidden">
            <!-- Left: Contract preview (iframe) -->
            <div class="flex-1 overflow-hidden relative bg-white">
                <div x-show="contractLoading" class="absolute inset-0 flex items-center justify-center bg-slate-950">
                    <div class="text-center">
                        <i class="ph ph-spinner animate-spin text-4xl text-amber-400"></i>
                        <p class="text-slate-400 text-sm mt-3">Cargando contrato...</p>
                    </div>
                </div>
                <iframe x-show="!contractLoading" :src="contractIframeSrc" @load="contractLoading=false"
                    class="w-full h-full border-0"></iframe>
            </div>

            <!-- Right: Signature panel -->
            <div class="w-[380px] flex-shrink-0 bg-slate-900 border-l border-slate-800 flex flex-col">
                <div class="p-5 flex-1 flex flex-col">
                    <h3 class="text-lg font-bold text-white mb-1 flex items-center gap-2">
                        <i class="ph ph-pen text-amber-400"></i> Firma del Cliente
                    </h3>
                    <p class="text-xs text-slate-400 mb-4">El cliente debe firmar aqu√≠ para completar el contrato de
                        consignaci√≥n.</p>

                    <!-- Signer info -->
                    <div class="bg-slate-800/60 rounded-xl p-3 mb-4 border border-slate-700">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center">
                                <i class="ph ph-user text-lg text-amber-400"></i>
                            </div>
                            <div>
                                <p class="text-white text-sm font-semibold" x-text="contractClientName"></p>
                                <p class="text-slate-400 text-xs" x-text="contractClientRut"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Digital cert info -->
                    <div class="bg-blue-900/20 rounded-xl p-3 mb-4 border border-blue-800/40">
                        <p class="text-xs text-blue-400 font-semibold flex items-center gap-1 mb-1">
                            <i class="ph ph-shield-check"></i> Certificado Digital
                        </p>
                        <p class="text-xs text-blue-300">Firmado digitalmente por <b>Felipe Horacio Y√°√±ez Fern√°ndez</b>
                        </p>
                        <p class="text-[10px] text-blue-400/70 mt-0.5">E-CERTCHILE CA FES 02 ¬∑ V√°lido hasta Feb 2027</p>
                    </div>

                    <!-- Signature Canvas -->
                    <div x-show="!contractSigned" class="flex-1 flex flex-col">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-xs text-slate-400 font-semibold uppercase tracking-wider">Dibuje su
                                firma</label>
                            <button @click="clearSignature()"
                                class="text-[10px] text-red-400 hover:text-red-300 flex items-center gap-1">
                                <i class="ph ph-eraser"></i> Borrar
                            </button>
                        </div>
                        <div class="relative bg-white rounded-xl border-2 border-dashed border-slate-600 overflow-hidden"
                            style="height: 160px; touch-action: none;">
                            <canvas id="signatureCanvas" class="w-full h-full cursor-crosshair"
                                @mousedown="startDrawing($event)" @mousemove="draw($event)" @mouseup="stopDrawing()"
                                @mouseleave="stopDrawing()" @touchstart.prevent="startDrawingTouch($event)"
                                @touchmove.prevent="drawTouch($event)" @touchend.prevent="stopDrawing()">
                            </canvas>
                            <!-- Placeholder text -->
                            <div x-show="!signatureStarted"
                                class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <p class="text-slate-300 text-sm italic">Firme aqu√≠ con el dedo o mouse</p>
                            </div>
                        </div>
                    </div>

                    <!-- Already Signed State -->
                    <div x-show="contractSigned"
                        class="flex-1 flex flex-col items-center justify-center text-center p-4">
                        <i class="ph ph-check-circle text-5xl text-green-500 mb-3"></i>
                        <h4 class="text-white font-bold text-lg mb-2">Contrato Firmado</h4>
                        <p class="text-slate-400 text-sm">El cliente ya ha firmado este documento digitalmente. El
                            contrato final se encuentra guardado de forma permanente.</p>
                    </div>
                </div>

                <!-- Submit signature -->
                <div class="p-5 border-t border-slate-800 space-y-2">
                    <button x-show="!contractSigned" @click="submitSignature()"
                        :disabled="!signatureStarted || contractSigning"
                        class="w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-500 disabled:opacity-40 text-white py-3 rounded-xl text-sm font-bold transition-all">
                        <span x-show="!contractSigning" class="flex items-center gap-2">
                            <i class="ph ph-check-circle text-lg"></i> Firmar Contrato
                        </span>
                        <span x-show="contractSigning" class="flex items-center gap-2" style="display:none;">
                            <i class="ph ph-spinner animate-spin text-lg"></i> Firmando...
                        </span>
                    </button>
                    <button @click="contractOpen=false"
                        class="w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-xl text-xs font-semibold transition-colors">
                        <span x-text="contractSigned ? 'Cerrar' : 'Omitir por ahora'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- ‚ïê‚ïê‚ïê INSPECTION FULL-SCREEN OVERLAY ‚ïê‚ïê‚ïê -->
    <div x-show="inspectionOpen" class="fixed inset-0 z-[90] bg-slate-950 flex flex-col overflow-hidden"
        style="display:none;">
        <!-- Top bar -->
        <div class="h-14 flex-shrink-0 bg-slate-900 border-b border-slate-800 flex items-center px-6 gap-4">
            <button @click="inspectionOpen=false; inspStep=1"
                class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm">
                <i class="ph ph-arrow-left text-lg"></i> Volver
            </button>
            <div class="flex-1 flex items-center gap-2">
                <i class="ph ph-magnifying-glass text-amber-400"></i>
                <span class="text-white font-semibold text-sm">Inspecci√≥n ‚Äî</span>
                <span class="text-amber-400 text-sm font-mono"
                    x-text="(consigDetail?.car_make||'') + ' ' + (consigDetail?.car_model||'') + ' ' + (consigDetail?.plate ? '¬∑ '+consigDetail.plate : '')"></span>
            </div>
            <!-- Step pills -->
            <div class="flex items-center gap-1">
                <template x-for="(s,i) in inspSteps" :key="i">
                    <div class="flex items-center gap-1">
                        <button @click="inspStep=i+1"
                            :class="inspStep===i+1 ? 'bg-amber-500 text-slate-900' : (inspStep>i+1 ? 'bg-green-600 text-white' : 'bg-slate-800 text-slate-400')"
                            class="w-7 h-7 rounded-full text-xs font-bold transition-all flex items-center justify-center"
                            x-text="inspStep>i+1 ? '‚úì' : (i+1)"></button>
                        <div x-show="i<inspSteps.length-1" class="w-4 h-px"
                            :class="inspStep>i+1 ? 'bg-green-600' : 'bg-slate-700'"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Step label -->
        <div class="flex-shrink-0 px-8 pt-5 pb-2">
            <h2 class="text-xl font-bold text-white" x-text="inspSteps[inspStep-1]?.label"></h2>
            <p class="text-slate-500 text-sm mt-0.5" x-text="inspSteps[inspStep-1]?.desc"></p>
        </div>

        <!-- Body scrollable -->
        <div class="flex-1 overflow-y-auto px-8 pb-8">

            <!-- STEP 1: Owner & Vehicle -->
            <div x-show="inspStep===1" class="grid grid-cols-2 gap-6 mt-4">
                <div class="space-y-4">
                    <h3 class="text-xs font-semibold text-blue-400 uppercase tracking-wider">Datos del Due√±o</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Nombre</label>
                            <input type="text" x-model="insp.clientNombre" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Apellido</label>
                            <input type="text" x-model="insp.clientApellido" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">RUT</label>
                            <input type="text" x-model="insp.clientRut" placeholder="12.345.678-9" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Tel√©fono</label>
                            <input type="text" x-model="insp.clientTelefono" class="insp-input">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-slate-400 mb-1">Email</label>
                            <input type="email" x-model="insp.clientEmail" class="insp-input">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-slate-400 mb-1">Direcci√≥n</label>
                            <input type="text" x-model="insp.clientDireccion" class="insp-input">
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <h3 class="text-xs font-semibold text-amber-400 uppercase tracking-wider">Datos del Veh√≠culo</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Patente *</label>
                            <input type="text" x-model="insp.vehiclePatente" placeholder="AB-1234"
                                class="insp-input font-mono uppercase">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">D√≠gito Patente</label>
                            <input type="text" x-model="insp.digitoPatente" placeholder="D√≠gito verificador"
                                maxlength="1" class="insp-input font-mono uppercase">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">A√±o *</label>
                            <input type="number" x-model.number="insp.vehicleAno" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Marca *</label>
                            <input type="text" x-model="insp.vehicleMarca" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Modelo *</label>
                            <input type="text" x-model="insp.vehicleModelo" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Versi√≥n</label>
                            <input type="text" x-model="insp.vehicleVersion" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Kilometraje *</label>
                            <input type="number" x-model.number="insp.vehicleKm" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Color</label>
                            <input type="text" x-model="insp.vehicleColor" placeholder="Blanco, Negro..."
                                class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Motor</label>
                            <input type="text" x-model="insp.vehicleMotor" placeholder="1.6L, 2.0T..."
                                class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Transmisi√≥n</label>
                            <select x-model="insp.vehicleTransmision" class="insp-input">
                                <option>Manual</option>
                                <option>Autom√°tico</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Combustible</label>
                            <select x-model="insp.vehicleCombustible" class="insp-input">
                                <option>Bencina</option>
                                <option>Diesel</option>
                                <option>El√©ctrico</option>
                                <option>H√≠brido</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Tipo de carrocer√≠a</label>
                            <input type="text" x-model="insp.vehicleBodyType" placeholder="SUV, Sed√°n, Hatchback..."
                                class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Tracci√≥n</label>
                            <select x-model="insp.traccion" class="insp-input">
                                <option value="">‚Äî</option>
                                <option>4x2</option>
                                <option>4x4</option>
                                <option>AWD</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 2: Documentation & Legal -->
            <div x-show="inspStep===2" class="grid grid-cols-2 gap-6 mt-4">
                <div class="space-y-4">
                    <h3 class="text-xs font-semibold text-blue-400 uppercase tracking-wider mb-1">Documentaci√≥n</h3>

                    <!-- Permiso Circulaci√≥n -->
                    <div class="bg-slate-800/60 rounded-xl p-4 space-y-3">
                        <p class="text-sm font-semibold text-white">Permiso de Circulaci√≥n</p>
                        <div class="flex gap-2">
                            <button type="button" @click="insp.permisoCirculacion=true"
                                :class="insp.permisoCirculacion===true ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'"
                                class="flex-1 py-2 rounded-lg text-sm font-medium transition-all">S√≠</button>
                            <button type="button" @click="insp.permisoCirculacion=false"
                                :class="insp.permisoCirculacion===false ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-400'"
                                class="flex-1 py-2 rounded-lg text-sm font-medium transition-all">No</button>
                        </div>
                        <input type="month" x-model="insp.permisoVence" placeholder="Vencimiento"
                            class="insp-input text-xs">
                    </div>

                    <!-- Revisi√≥n T√©cnica -->
                    <div class="bg-slate-800/60 rounded-xl p-4 space-y-3">
                        <p class="text-sm font-semibold text-white">Revisi√≥n T√©cnica</p>
                        <div class="flex gap-2">
                            <button type="button" @click="insp.revisionTecnica=true"
                                :class="insp.revisionTecnica===true ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'"
                                class="flex-1 py-2 rounded-lg text-sm font-medium transition-all">S√≠</button>
                            <button type="button" @click="insp.revisionTecnica=false"
                                :class="insp.revisionTecnica===false ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-400'"
                                class="flex-1 py-2 rounded-lg text-sm font-medium transition-all">No</button>
                        </div>
                        <input type="month" x-model="insp.revisionVence" placeholder="Vencimiento"
                            class="insp-input text-xs">
                    </div>

                    <!-- SOAP -->
                    <div class="bg-slate-800/60 rounded-xl p-4 space-y-3">
                        <p class="text-sm font-semibold text-white">SOAP</p>
                        <div class="flex gap-2">
                            <button type="button" @click="insp.soap=true"
                                :class="insp.soap===true ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'"
                                class="flex-1 py-2 rounded-lg text-sm font-medium transition-all">S√≠</button>
                            <button type="button" @click="insp.soap=false"
                                :class="insp.soap===false ? 'bg-red-600 text-white' : 'bg-slate-700 text-slate-400'"
                                class="flex-1 py-2 rounded-lg text-sm font-medium transition-all">No</button>
                        </div>
                        <input type="text" x-model="insp.soapCompania" placeholder="Compa√±√≠a SOAP"
                            class="insp-input text-xs">
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xs font-semibold text-amber-400 uppercase tracking-wider mb-1">Precios & Legal</h3>

                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">ü§ñ Valor Mercado Real (IA) (CLP)</label>
                            <input type="number" x-model.number="insp.aiMarketPrice" class="insp-input"
                                placeholder="C√°lculo IA del precio real">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">‚ö° Compra Inmediata (IA) (CLP)</label>
                            <input type="number" x-model.number="insp.aiInstantBuyPrice" class="insp-input"
                                placeholder="Precio de toma/compra inmediata">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Tasaci√≥n Fiscal (CLP)</label>
                            <input type="number" x-model.number="insp.tasacion" placeholder="$" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Publicaci√≥n de Due√±o (CLP)</label>
                            <input type="number" x-model.number="insp.precioPublicado" class="insp-input"
                                placeholder="Precio que pide el due√±o en FB">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">üí∞ Precio a Vender (CLP)</label>
                            <input type="number" x-model.number="insp.precioSugerido" class="insp-input"
                                placeholder="Precio real para publicar y contrato de venta">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Comisi√≥n (CLP)</label>
                            <input type="number" x-model.number="insp.comision" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">N√∫mero de Due√±os</label>
                            <input type="number" x-model.number="insp.numDuenos" class="insp-input">
                        </div>
                    </div>

                    <!-- En Prenda -->
                    <div class="bg-slate-800/60 rounded-xl p-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" x-model="insp.enPrenda" class="w-5 h-5 rounded accent-red-500">
                            <span :class="insp.enPrenda ? 'text-red-400' : 'text-white'" class="font-bold text-sm">¬øEst√°
                                en Prenda?</span>
                        </label>
                        <div x-show="insp.enPrenda"
                            class="mt-2 text-xs text-red-400 bg-red-500/10 border border-red-500/20 rounded-lg p-2">
                            ‚ö†Ô∏è Veh√≠culo con restricciones legales
                        </div>
                    </div>

                    <div class="bg-slate-800/60 rounded-xl p-4">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" x-model="insp.enRemate" class="w-5 h-5 rounded accent-orange-500">
                            <span class="text-white font-bold text-sm">¬øEn Remate?</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- STEP 3: Features -->
            <div x-show="inspStep===3" class="mt-4">
                <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    <template x-for="(feat, key) in insp.features" :key="key">
                        <label
                            class="flex items-center gap-3 p-3 bg-slate-800/60 border border-slate-700 rounded-xl cursor-pointer hover:border-amber-500/40 transition-all"
                            :class="insp.features[key] ? 'border-amber-500/50 bg-amber-500/10' : ''">
                            <input type="checkbox" x-model="insp.features[key]" class="w-4 h-4 accent-amber-500">
                            <span class="text-xs text-slate-300 capitalize leading-tight"
                                x-text="key.replace(/([A-Z])/g,' $1').trim()"></span>
                        </label>
                    </template>
                </div>
            </div>

            <!-- STEP 4: Technical & Tires -->
            <div x-show="inspStep===4" class="grid grid-cols-2 gap-6 mt-4">
                <div class="space-y-4">
                    <h3 class="text-xs font-semibold text-blue-400 uppercase tracking-wider">T√©cnico</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">Airbags</label>
                            <input type="number" x-model.number="insp.airbags" class="insp-input">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-400 mb-1">N√∫mero de Llaves</label>
                            <input type="number" x-model.number="insp.numLlaves" class="insp-input">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs text-slate-400 mb-1">Qui√©n tom√≥ las fotos</label>
                            <input type="text" x-model="insp.quienTomoFotos" class="insp-input">
                        </div>
                    </div>

                    <!-- Neum√°ticos -->
                    <div>
                        <label class="block text-xs text-slate-400 mb-3">Neum√°ticos (4 + repuesto)</label>
                        <div class="flex gap-3">
                            <template x-for="(ok, idx) in insp.neumaticos" :key="idx">
                                <button type="button" @click="insp.neumaticos[idx]=!insp.neumaticos[idx]"
                                    :class="insp.neumaticos[idx] ? 'bg-blue-600 border-blue-500 text-white shadow-lg shadow-blue-500/20' : 'bg-slate-800 border-slate-600 text-slate-500'"
                                    class="w-14 h-14 rounded-full border-2 flex flex-col items-center justify-center transition-all">
                                    <i class="ph ph-circle-dashed text-xl"></i>
                                    <span class="text-[9px] mt-0.5" x-text="idx===4?'Rep':idx+1"></span>
                                </button>
                            </template>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Observaciones generales</label>
                        <textarea x-model="insp.observaciones" rows="5" class="insp-input resize-none"
                            placeholder="Motor, carrocer√≠a, detalles..."></textarea>
                    </div>
                </div>

                <div class="space-y-4">
                    <h3 class="text-xs font-semibold text-amber-400 uppercase tracking-wider">Fotos del Veh√≠culo</h3>

                    <!-- Camera / Upload buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- üì∏ Camera (mobile/webcam) -->
                        <button type="button" @click="$refs.cameraInput.click()"
                            class="flex flex-col items-center justify-center gap-2 p-5 bg-amber-600/20 border-2 border-amber-500/40 hover:border-amber-400 hover:bg-amber-600/30 rounded-xl transition-all text-amber-400">
                            <i class="ph ph-camera text-3xl"></i>
                            <span class="text-sm font-semibold">Tomar Foto</span>
                            <span class="text-[10px] text-amber-500/70">C√°mara del dispositivo</span>
                        </button>
                        <input type="file" accept="image/*" capture="environment" multiple x-ref="cameraInput"
                            class="hidden" @change="handlePhotoUpload($event)">

                        <!-- üìÅ File upload -->
                        <button type="button" @click="$refs.photoInput.click()"
                            class="flex flex-col items-center justify-center gap-2 p-5 bg-slate-700/50 border-2 border-slate-600 hover:border-slate-400 hover:bg-slate-700 rounded-xl transition-all text-slate-300">
                            <i class="ph ph-folder-open text-3xl"></i>
                            <span class="text-sm font-semibold">Subir Archivos</span>
                            <span class="text-[10px] text-slate-500">JPG, PNG desde galer√≠a</span>
                        </button>
                        <input type="file" accept="image/*" multiple x-ref="photoInput" class="hidden"
                            @change="handlePhotoUpload($event)">
                    </div>

                    <!-- Photo count badge -->
                    <div x-show="insp.photos.length > 0"
                        class="flex items-center gap-2 text-xs text-green-400 bg-green-500/10 border border-green-500/20 rounded-lg px-3 py-2">
                        <i class="ph ph-check-circle"></i>
                        <span x-text="insp.photos.length + ' foto(s) lista(s) para subir'"></span>
                    </div>
                    <p x-show="insp.photos.length === 0" class="text-xs text-slate-600 text-center">Las fotos son
                        opcionales pero recomendadas</p>

                    <!-- Photo grid previews -->
                    <div x-show="insp.photos.length > 0" class="grid grid-cols-3 gap-2">
                        <template x-for="(photo, idx) in insp.photos" :key="idx">
                            <div
                                class="relative group rounded-lg overflow-hidden aspect-square bg-slate-800 border border-slate-700">
                                <img :src="photo.preview" class="w-full h-full object-cover">
                                <button type="button" @click="insp.photos.splice(idx,1)"
                                    class="absolute top-1 right-1 w-6 h-6 bg-red-600 rounded-full text-white text-xs items-center justify-center hidden group-hover:flex shadow-lg">
                                    <i class="ph ph-x text-[10px]"></i>
                                </button>
                                <span
                                    class="absolute bottom-0 left-0 right-0 text-[9px] bg-black/70 text-white px-1 py-0.5 truncate"
                                    x-text="photo.name"></span>
                            </div>
                        </template>
                        <!-- Add more -->
                        <button type="button" @click="$refs.photoInput.click()"
                            class="aspect-square rounded-lg border-2 border-dashed border-slate-700 hover:border-amber-500/50 flex items-center justify-center text-slate-600 hover:text-amber-400 transition-colors">
                            <i class="ph ph-plus text-2xl"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- STEP 5: Review & Submit -->
            <div x-show="inspStep===5" class="mt-4 space-y-4">
                <div class="grid grid-cols-3 gap-4">
                    <!-- Owner summary -->
                    <div class="bg-slate-800/60 rounded-xl p-4 border border-slate-700">
                        <p class="text-xs text-blue-400 font-semibold uppercase tracking-wider mb-3">Due√±o</p>
                        <p class="text-white text-sm font-semibold"
                            x-text="insp.clientNombre + ' ' + insp.clientApellido"></p>
                        <p class="text-slate-400 text-xs mt-1" x-text="insp.clientRut"></p>
                        <p class="text-slate-400 text-xs" x-text="insp.clientTelefono"></p>
                        <p class="text-slate-400 text-xs" x-text="insp.clientEmail"></p>
                    </div>
                    <!-- Vehicle summary -->
                    <div class="bg-slate-800/60 rounded-xl p-4 border border-slate-700">
                        <p class="text-xs text-amber-400 font-semibold uppercase tracking-wider mb-3">Veh√≠culo</p>
                        <p class="text-white text-sm font-bold font-mono" x-text="insp.vehiclePatente"></p>
                        <p class="text-slate-300 text-sm"
                            x-text="insp.vehicleMarca + ' ' + insp.vehicleModelo + ' ' + insp.vehicleAno"></p>
                        <p class="text-slate-400 text-xs mt-1"
                            x-text="(insp.vehicleKm||0).toLocaleString('es-CL') + ' km ¬∑ ' + (insp.vehicleColor||'‚Äî')">
                        </p>
                        <p class="text-slate-400 text-xs"
                            x-text="insp.vehicleTransmision + ' ¬∑ ' + insp.vehicleCombustible"></p>
                    </div>
                    <!-- Pricing summary -->
                    <div class="bg-slate-800/60 rounded-xl p-4 border border-slate-700">
                        <p class="text-xs text-green-400 font-semibold uppercase tracking-wider mb-3">Precios</p>
                        <div class="space-y-1">
                            <div class="flex justify-between items-center py-2 border-b border-white/5">
                                <span class="text-slate-400">ü§ñ Valor Mercado (IA)</span>
                                <span class="text-white font-mono"
                                    x-text="insp.aiMarketPrice ? new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP'}).format(insp.aiMarketPrice) : '‚Äî'"></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-white/5">
                                <span class="text-slate-400">‚ö° Compra Inmediata (IA)</span>
                                <span class="text-white font-mono"
                                    x-text="insp.aiInstantBuyPrice ? new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP'}).format(insp.aiInstantBuyPrice) : '‚Äî'"></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-white/5">
                                <span class="text-slate-400">Tasaci√≥n Fiscal</span>
                                <span class="text-white font-mono"
                                    x-text="insp.tasacion ? new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP'}).format(insp.tasacion) : '‚Äî'"></span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-white/5">
                                <span class="text-slate-400">Publicado</span>
                                <span class="text-white font-mono"
                                    x-text="insp.precioPublicado ? new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP'}).format(insp.precioPublicado) : '‚Äî'"></span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-400">En Prenda</span>
                                <span :class="insp.enPrenda ? 'text-red-400' : 'text-green-400'"
                                    x-text="insp.enPrenda ? 'S√ç ‚ö†Ô∏è' : 'No'"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Docs row -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-slate-800/60 rounded-xl p-4 border border-slate-700 flex items-center gap-3">
                        <i class="ph ph-file-text text-xl"
                            :class="insp.permisoCirculacion ? 'text-green-400' : 'text-red-400'"></i>
                        <div>
                            <p class="text-xs text-slate-400">Permiso Circulaci√≥n</p>
                            <p class="text-sm font-semibold"
                                :class="insp.permisoCirculacion ? 'text-green-400' : 'text-red-400'"
                                x-text="insp.permisoCirculacion ? 'Al d√≠a' : 'Sin permiso'"></p>
                        </div>
                    </div>
                    <div class="bg-slate-800/60 rounded-xl p-4 border border-slate-700 flex items-center gap-3">
                        <i class="ph ph-shield-check text-xl"
                            :class="insp.revisionTecnica ? 'text-green-400' : 'text-red-400'"></i>
                        <div>
                            <p class="text-xs text-slate-400">Revisi√≥n T√©cnica</p>
                            <p class="text-sm font-semibold"
                                :class="insp.revisionTecnica ? 'text-green-400' : 'text-red-400'"
                                x-text="insp.revisionTecnica ? 'Al d√≠a' : 'Sin revisi√≥n'"></p>
                        </div>
                    </div>
                    <div class="bg-slate-800/60 rounded-xl p-4 border border-slate-700 flex items-center gap-3">
                        <i class="ph ph-camera text-xl text-slate-400"></i>
                        <div>
                            <p class="text-xs text-slate-400">Fotos</p>
                            <p class="text-sm font-semibold text-white" x-text="insp.photos.length + ' foto(s)'"></p>
                        </div>
                    </div>
                </div>

                <!-- Features summary -->
                <div class="bg-slate-800/60 rounded-xl p-4 border border-slate-700">
                    <p class="text-xs text-slate-400 font-semibold uppercase tracking-wider mb-3">Equipamiento activo
                    </p>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="(val, key) in insp.features" :key="key">
                            <span x-show="val" class="px-2 py-0.5 bg-amber-500/20 text-amber-400 text-xs rounded-full"
                                x-text="key.replace(/([A-Z])/g,' $1').trim()"></span>
                        </template>
                        <span x-show="!Object.values(insp.features).some(Boolean)"
                            class="text-xs text-slate-600">Ninguno seleccionado</span>
                    </div>
                </div>

                <!-- Submit button -->
                <div class="pt-4">
                    <button @click="submitInspection()" :disabled="inspSaving"
                        class="w-full flex items-center justify-center gap-3 bg-green-600 hover:bg-green-500 disabled:opacity-50 text-white py-4 rounded-xl font-bold text-base transition-all shadow-lg shadow-green-900/30">
                        <span x-show="!inspSaving" class="flex items-center gap-2">
                            <i class="ph ph-check-circle text-xl"></i> Guardar Inspecci√≥n Completa
                        </span>
                        <span x-show="inspSaving" class="flex items-center gap-2" style="display:none;">
                            <i class="ph ph-spinner animate-spin text-xl"></i> Guardando en Supabase...
                        </span>
                    </button>
                    <p class="text-center text-xs text-slate-600 mt-2">
                        Se guardar√° en Supabase
                        <span x-show="insp.photos.length > 0" class="text-amber-400"
                            x-text="' + ' + insp.photos.length + ' foto(s)'"></span>
                        y marcar√° la consignaci√≥n como Parte 2 ‚úì
                    </p>
                </div>
            </div>
        </div>

        <!-- Bottom nav -->
        <div class="flex-shrink-0 bg-slate-900 border-t border-slate-800 px-8 py-4 flex items-center justify-between">
            <button @click="inspStep > 1 ? inspStep-- : (inspectionOpen=false)"
                class="flex items-center gap-2 px-5 py-2.5 bg-slate-800 hover:bg-slate-700 text-white rounded-xl text-sm font-medium transition-colors">
                <i class="ph ph-arrow-left"></i>
                <span x-text="inspStep===1 ? 'Cancelar' : 'Anterior'"></span>
            </button>
            <span class="text-xs text-slate-500" x-text="'Paso ' + inspStep + ' de ' + inspSteps.length"></span>
            <button x-show="inspStep < inspSteps.length" @click="if(inspValidate(inspStep)) inspStep++"
                class="flex items-center gap-2 px-5 py-2.5 bg-amber-600 hover:bg-amber-500 text-white rounded-xl text-sm font-medium transition-colors">
                Siguiente <i class="ph ph-arrow-right"></i>
            </button>
            <button x-show="inspStep === inspSteps.length" @click="submitInspection()" :disabled="inspSaving"
                class="flex items-center gap-2 px-5 py-2.5 bg-green-600 hover:bg-green-500 disabled:opacity-50 text-white rounded-xl text-sm font-bold transition-all"
                style="display:none;">
                <i class="ph ph-check-circle"></i> Guardar Inspecci√≥n
            </button>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê CONSIGNACIONES VIEW ‚ïê‚ïê‚ïê -->
    <div x-show="currentView==='consignaciones'" class="flex-1 flex flex-col overflow-hidden" style="display:none;">
        <header class="h-16 glass border-b border-slate-700 flex items-center justify-between px-8 shrink-0">
            <div class="flex items-center gap-3">
                <i class="ph ph-clipboard-text text-xl text-amber-400"></i>
                <h2 class="text-lg font-semibold text-white">Consignaciones</h2>
            </div>
            <div class="flex gap-2">
                <template
                    x-for="f in [['todas','Todas'],['pendiente','Pendientes'],['parte1_completa','Parte 1'],['parte2_completa','Parte 2'],['en_venta','En Venta']]"
                    :key="f[0]">
                    <button @click="consigFilter=f[0]; loadConsignaciones()"
                        :class="consigFilter===f[0] ? 'bg-amber-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'"
                        class="px-3 py-1.5 rounded-lg text-xs font-medium transition-colors" x-text="f[1]"></button>
                </template>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- List -->
            <div class="flex-1 overflow-y-auto p-6 space-y-3">
                <template x-for="c in consignaciones" :key="c.id">
                    <div class="glass rounded-xl p-5 border border-slate-700 hover:border-amber-500/30 transition-all cursor-pointer"
                        @click="openConsignacion(c.id)">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <!-- Header row -->
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-xs font-mono text-slate-500">#<span x-text="c.id"></span></span>
                                    <span class="text-xs px-2 py-0.5 rounded-full font-semibold" :class="{
                                            'bg-slate-700 text-slate-400': c.status==='pendiente',
                                            'bg-blue-500/20 text-blue-400': c.status==='parte1_completa',
                                            'bg-amber-500/20 text-amber-400': c.status==='parte2_completa',
                                            'bg-green-500/20 text-green-400': c.status==='en_venta',
                                            'bg-purple-500/20 text-purple-400': c.status==='vendida'
                                        }"
                                        x-text="{pendiente:'Pendiente',parte1_completa:'Parte 1 ‚úì',parte2_completa:'Parte 2 ‚úì',en_venta:'En Venta',vendida:'Vendida'}[c.status] || c.status"></span>
                                    <span x-show="c.assigned_user_name"
                                        class="flex items-center gap-1 text-xs text-slate-400">
                                        <span class="w-2.5 h-2.5 rounded-full"
                                            :style="'background:' + (c.assigned_user_color || '#3b82f6')"></span>
                                        <span x-text="c.assigned_user_name"></span>
                                    </span>
                                </div>
                                <!-- Name + vehicle -->
                                <p class="text-white font-semibold mb-0.5"
                                    x-text="c.owner_full_name || (c.owner_first_name + ' ' + (c.owner_last_name||''))">
                                </p>
                                <p class="text-sm text-slate-400"
                                    x-text="[c.car_make, c.car_model, c.car_year].filter(Boolean).join(' ') + (c.plate ? ' ¬∑ ' + c.plate : '')">
                                </p>
                            </div>
                            <div class="text-right shrink-0 ml-4">
                                <p x-show="c.appointment_date" class="text-xs text-cyan-400 mb-1"
                                    x-text="c.appointment_date + (c.appointment_time ? ' ' + c.appointment_time : '')">
                                </p>
                                <p x-show="c.selling_price" class="text-sm font-semibold text-green-400"
                                    x-text="formatCLP(c.selling_price)"></p>
                            </div>
                        </div>
                        <!-- Progress bar -->
                        <div class="mt-3 flex gap-1.5">
                            <div class="h-1 flex-1 rounded-full"
                                :class="['parte1_completa','parte2_completa','en_venta','vendida'].includes(c.status) ? 'bg-blue-500' : 'bg-slate-700'">
                            </div>
                            <div class="h-1 flex-1 rounded-full"
                                :class="['parte2_completa','en_venta','vendida'].includes(c.status) ? 'bg-amber-500' : 'bg-slate-700'">
                            </div>
                            <div class="h-1 flex-1 rounded-full"
                                :class="['en_venta','vendida'].includes(c.status) ? 'bg-green-500' : 'bg-slate-700'">
                            </div>
                        </div>
                    </div>
                </template>
                <div x-show="consignaciones.length===0" class="text-center py-16 text-slate-500">
                    <i class="ph ph-clipboard-text text-4xl block mb-3"></i>
                    <p class="text-sm">Sin consignaciones a√∫n</p>
                    <p class="text-xs text-slate-600 mt-1">Se crean desde el Calendario al asignar una cita</p>
                </div>
            </div>

            <!-- Detail Panel -->
            <div x-show="consigDetailOpen"
                class="w-96 border-l border-slate-700 flex flex-col overflow-hidden shrink-0 bg-slate-900">
                <div class="px-5 py-4 border-b border-slate-700 flex items-center justify-between">
                    <h3 class="text-white font-semibold" x-text="'Consignaci√≥n #' + (consigDetail?.id || '')"></h3>
                    <button @click="consigDetailOpen=false"
                        class="text-slate-400 hover:text-white p-1 rounded transition-colors">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <!-- Status + progress -->
                    <div class="px-5 py-4 border-b border-slate-800">
                        <div class="flex gap-1 mb-3">
                            <div class="h-2 flex-1 rounded-full"
                                :class="['parte1_completa','parte2_completa','en_venta','vendida'].includes(consigDetail?.status) ? 'bg-blue-500' : 'bg-slate-700'">
                            </div>
                            <div class="h-2 flex-1 rounded-full"
                                :class="['parte2_completa','en_venta','vendida'].includes(consigDetail?.status) ? 'bg-amber-500' : 'bg-slate-700'">
                            </div>
                            <div class="h-2 flex-1 rounded-full"
                                :class="['en_venta','vendida'].includes(consigDetail?.status) ? 'bg-green-500' : 'bg-slate-700'">
                            </div>
                        </div>
                        <div class="flex gap-1.5 flex-wrap">
                            <template
                                x-for="s in [['pendiente','Pendiente'],['parte1_completa','Parte 1 ‚úì'],['parte2_completa','Parte 2 ‚úì'],['en_venta','En Venta'],['vendida','Vendida']]"
                                :key="s[0]">
                                <button @click="saveConsignacion(consigDetail.id, {status: s[0]})"
                                    :class="consigDetail?.status===s[0] ? 'bg-amber-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'"
                                    class="px-2.5 py-1 rounded-lg text-xs font-medium transition-all"
                                    x-text="s[1]"></button>
                            </template>
                        </div>
                    </div>
                    <!-- PART 1: Contact Info -->
                    <div class="px-5 py-4 border-b border-slate-800">
                        <h4
                            class="text-xs font-semibold text-blue-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                            <i class="ph ph-user"></i> Parte 1 ‚Äî Datos del Due√±o
                        </h4>
                        <div class="space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] text-slate-500 uppercase">Nombre</label>
                                    <input type="text" :value="consigDetail?.owner_first_name"
                                        @change="consigEdits.owner_first_name=$event.target.value"
                                        class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 uppercase">Apellido</label>
                                    <input type="text" :value="consigDetail?.owner_last_name"
                                        @change="consigEdits.owner_last_name=$event.target.value"
                                        class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">RUT</label>
                                <input type="text" :value="consigDetail?.owner_rut"
                                    @change="consigEdits.owner_rut=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Tel√©fono</label>
                                <input type="text"
                                    :value="(consigDetail?.owner_country_code||'+56') + ' ' + (consigDetail?.owner_phone||'')"
                                    @change="consigEdits.owner_phone=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Email</label>
                                <input type="text" :value="consigDetail?.owner_email"
                                    @change="consigEdits.owner_email=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Direcci√≥n</label>
                                <input type="text"
                                    :value="[consigDetail?.owner_address, consigDetail?.owner_commune, consigDetail?.owner_region].filter(Boolean).join(', ')"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500"
                                    readonly>
                            </div>
                        </div>
                    </div>
                    <!-- PART 1: Vehicle -->
                    <div class="px-5 py-4 border-b border-slate-800">
                        <h4
                            class="text-xs font-semibold text-blue-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                            <i class="ph ph-car-simple"></i> Parte 1 ‚Äî Datos del Veh√≠culo
                        </h4>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Patente</label>
                                <input type="text" :value="consigDetail?.plate"
                                    @change="consigEdits.plate=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs font-mono focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">A√±o</label>
                                <input type="number" :value="consigDetail?.car_year"
                                    @change="consigEdits.car_year=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Marca</label>
                                <input type="text" :value="consigDetail?.car_make"
                                    @change="consigEdits.car_make=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Modelo</label>
                                <input type="text" :value="consigDetail?.car_model"
                                    @change="consigEdits.car_model=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Kilometraje</label>
                                <input type="number" :value="consigDetail?.mileage"
                                    @change="consigEdits.mileage=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="text-[10px] text-slate-500 uppercase">Versi√≥n</label>
                                <input type="text" :value="consigDetail?.version"
                                    @change="consigEdits.version=$event.target.value"
                                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-white text-xs focus:outline-none focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    <!-- PART 2: Field Inspection -->
                    <div class="px-5 py-4 border-b border-slate-800">
                        <h4
                            class="text-xs font-semibold text-amber-400 uppercase tracking-wider mb-3 flex items-center gap-1">
                            <i class="ph ph-magnifying-glass"></i> Parte 2 ‚Äî Inspecci√≥n en Campo
                        </h4>

                        <!-- Already completed badge ‚Äî CLICKABLE to view report -->
                        <div x-show="consigDetail?.appraisal_supabase_id"
                            @click="viewInspection(consigDetail.appraisal_supabase_id)"
                            class="mb-3 p-3 bg-green-900/30 border border-green-700/50 rounded-lg cursor-pointer hover:bg-green-900/50 transition-colors group">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <i class="ph ph-check-circle text-green-400"></i>
                                    <span class="text-xs font-semibold text-green-400">Inspecci√≥n completada</span>
                                </div>
                                <div
                                    class="flex items-center gap-1 text-green-400/70 group-hover:text-green-300 transition-colors">
                                    <span class="text-[10px] font-medium">Ver informe</span>
                                    <i class="ph ph-arrow-right text-xs"></i>
                                </div>
                            </div>
                            <p class="text-[10px] text-slate-500 font-mono truncate mt-1"
                                x-text="'ID: ' + consigDetail?.appraisal_supabase_id"></p>
                        </div>

                        <!-- Open embedded inspection -->
                        <button @click="openInspection(consigDetail)"
                            class="w-full flex items-center justify-center gap-2 bg-amber-600 hover:bg-amber-500 text-white py-2.5 rounded-lg text-sm font-semibold transition-colors">
                            <i class="ph ph-clipboard-text text-base"></i>
                            <span
                                x-text="consigDetail?.appraisal_supabase_id ? 'Nueva Inspecci√≥n' : 'Iniciar Inspecci√≥n Completa'"></span>
                            <i class="ph ph-arrow-right text-xs"></i>
                        </button>
                        <p class="text-[10px] text-slate-600 text-center mt-1">Formulario de 5 pasos + fotos integrado
                        </p>
                    </div>
                    <!-- Actions -->
                    <div class="px-5 py-4 flex flex-col gap-2">
                        <button @click="saveConsignacion(consigDetail.id, consigEdits)"
                            class="w-full bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="ph ph-floppy-disk mr-1"></i> Guardar cambios Parte 1
                        </button>
                        <button x-show="consigDetail?.status==='parte2_completa' || consigDetail?.appraisal_supabase_id"
                            @click="promoteToInventory(consigDetail.id)"
                            class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-sm font-medium transition-colors">
                            <i class="ph ph-arrow-up-right mr-1"></i> Promover a Inventario
                        </button>
                        <!-- CONTRACT -->
                        <div x-show="consigDetail?.appraisal_supabase_id || consigDetail?.status !== 'pendiente'"
                            class="mt-1">
                            <button @click="openContract(consigDetail.id)"
                                class="w-full flex items-center justify-center gap-2 text-white py-2 rounded-lg text-sm font-medium transition-colors"
                                :class="consigDetail?.contract_signed_at ? 'bg-emerald-700 hover:bg-emerald-600' : 'bg-amber-700 hover:bg-amber-600'">
                                <i class="ph text-base"
                                    :class="consigDetail?.contract_signed_at ? 'ph-check-circle' : 'ph-file-text'"></i>
                                <span
                                    x-text="consigDetail?.contract_signed_at ? 'Ver Contrato Firmado' : 'Generar / Firmar Contrato'"></span>
                            </button>
                        </div>
                        <!-- PUBLISH TO WEBSITE -->
                        <div x-show="consigDetail?.appraisal_supabase_id" class="mt-1">
                            <button @click="publishToWebsite(consigDetail.id)"
                                :disabled="publishingId === consigDetail?.id" x-show="!consigDetail?.listing_id"
                                class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white py-2.5 rounded-lg text-sm font-semibold transition-colors shadow-lg shadow-blue-900/30">
                                <i class="ph ph-globe text-base"></i>
                                <span x-show="publishingId !== consigDetail?.id">Publicar en autodirecto.cl</span>
                                <span x-show="publishingId === consigDetail?.id" style="display:none;"><i
                                        class="ph ph-spinner animate-spin"></i> Publicando...</span>
                            </button>
                            <!-- Already published badge -->
                            <div x-show="consigDetail?.listing_id"
                                class="w-full flex items-center justify-between gap-2 bg-blue-900/30 border border-blue-700/50 text-blue-300 py-2.5 px-3 rounded-lg text-sm">
                                <span class="flex items-center gap-2 font-semibold">
                                    <i class="ph ph-check-circle text-base"></i> Publicado en el cat√°logo
                                </span>
                                <div class="flex gap-2">
                                    <a href="http://localhost:3000/catalogo" target="_blank"
                                        class="text-xs bg-blue-700 hover:bg-blue-600 text-white px-2 py-1 rounded transition-colors">
                                        Ver <i class="ph ph-arrow-square-out text-xs"></i>
                                    </a>
                                    <button @click="publishToWebsite(consigDetail.id)"
                                        class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded transition-colors">
                                        Actualizar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- CRM: Add Lead Modal                                                    -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div x-show="modals.crmAdd" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
        style="display:none;">
        <div class="glass w-full max-w-2xl rounded-2xl p-8 shadow-2xl transform transition-all max-h-[90vh] overflow-y-auto"
            @click.away="closeModal('crmAdd')">
            <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                <i class="ph ph-user-plus text-purple-400"></i> Nuevo Lead
            </h3>
            <form @submit.prevent="submitCRMLead()">
                <!-- Contact -->
                <h4 class="text-xs font-semibold text-purple-400 uppercase tracking-wider mb-3">Contacto</h4>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Nombre</label>
                        <input type="text" x-model="newCRMLead.first_name"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Apellido</label>
                        <input type="text" x-model="newCRMLead.last_name"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">RUT</label>
                        <input type="text" x-model="newCRMLead.rut" placeholder="12.345.678-9"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Tel√©fono</label>
                        <input type="tel" x-model="newCRMLead.phone"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Email</label>
                        <input type="email" x-model="newCRMLead.email"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                    </div>
                </div>
                <!-- Vehicle -->
                <div class="border-t border-slate-700 my-5 pt-4">
                    <h4 class="text-xs font-semibold text-purple-400 uppercase tracking-wider mb-3">Veh√≠culo</h4>
                    <div class="grid grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Marca</label>
                            <input type="text" x-model="newCRMLead.car_make"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Modelo</label>
                            <input type="text" x-model="newCRMLead.car_model"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">A√±o</label>
                            <input type="number" x-model="newCRMLead.car_year"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Patente</label>
                            <input type="text" x-model="newCRMLead.plate"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                        </div>
                    </div>
                </div>
                <!-- Priority & Stage -->
                <div class="border-t border-slate-700 my-5 pt-4">
                    <h4 class="text-xs font-semibold text-purple-400 uppercase tracking-wider mb-3">Pipeline</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Etapa</label>
                            <select x-model="newCRMLead.stage"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                                <template x-for="st in crmStageOrder" :key="st">
                                    <option :value="st" x-text="crmStageLabels[st]"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Prioridad</label>
                            <select x-model="newCRMLead.priority"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-purple-500">
                                <option value="high">üî¥ Alta</option>
                                <option value="medium" selected>üü° Media</option>
                                <option value="low">‚ö™ Baja</option>
                            </select>
                        </div>
                    </div>
                </div>
                <!-- Actions -->
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" @click="closeModal('crmAdd')"
                        class="px-4 py-2 text-slate-300 hover:text-white transition-colors">Cancelar</button>
                    <button type="submit"
                        class="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-lg font-medium shadow-lg shadow-purple-900/20 transition-all">
                        Crear Lead
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Car Modal -->
    <div x-show="modals.addCar" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
        style="display: none;">
        <div class="glass w-full max-w-2xl rounded-2xl p-8 shadow-2xl transform transition-all"
            @click.away="closeModal('addCar')">
            <h3 class="text-xl font-bold text-white mb-6">Nuevo Veh√≠culo</h3>
            <form @submit.prevent="submitCar">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Patente</label>
                        <input type="text" x-model="newCar.patente"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">VIN (Opcional)</label>
                        <input type="text" x-model="newCar.vin"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Marca</label>
                        <input type="text" x-model="newCar.brand"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Modelo</label>
                        <input type="text" x-model="newCar.model"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                            required>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">A√±o</label>
                        <input type="number" x-model="newCar.year"
                            class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <div class="border-t border-slate-700 my-6 pt-4">
                    <h4 class="text-sm font-semibold text-blue-400 mb-4 uppercase tracking-wider">Datos Consignaci√≥n &
                        Due√±o</h4>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">RUT Due√±o</label>
                            <input type="text" x-model="newCar.owner_rut" placeholder="12345678-9"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Nombre Due√±o</label>
                            <input type="text" x-model="newCar.owner_name"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                required>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Precio Venta (CLP)</label>
                            <input type="number" x-model="newCar.selling_price"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Precio Due√±o (CLP)</label>
                            <input type="number" x-model="newCar.owner_price"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Comisi√≥n % (0.10)</label>
                            <input type="number" step="0.01" x-model="newCar.commission_pct"
                                class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-3 mt-8">
                    <button type="button" @click="closeModal('addCar')"
                        class="px-4 py-2 text-slate-300 hover:text-white transition-colors">Cancelar</button>
                    <button type="submit"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-medium shadow-lg shadow-blue-900/20 transition-all">Guardar
                        Auto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         USUARIOS VIEW
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div x-show="currentView==='usuarios'" class="flex-1 flex flex-col overflow-hidden" style="display:none;">
        <!-- Header -->
        <div class="flex-shrink-0 px-6 py-4 border-b border-slate-800 flex items-center justify-between">
            <div>
                <h2 class="text-lg font-semibold text-white">Gesti√≥n de Usuarios</h2>
                <p class="text-xs text-slate-500 mt-0.5" x-text="usuarios.length + ' usuarios activos'"></p>
            </div>
            <button @click="usuarioAddOpen=!usuarioAddOpen"
                class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                <i class="ph ph-plus-circle"></i> Nuevo Usuario
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-4">
            <!-- Add user form -->
            <div x-show="usuarioAddOpen" class="bg-slate-800/50 border border-slate-700 rounded-xl p-5"
                style="display:none;">
                <h3 class="text-sm font-semibold text-white mb-4 flex items-center gap-2">
                    <i class="ph ph-user-plus text-blue-400"></i> Nuevo Usuario
                </h3>
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Nombre Completo</label>
                        <input type="text" x-model="newUsuario.name" placeholder="Felipe Yanez"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Email</label>
                        <input type="email" x-model="newUsuario.email" placeholder="felipe@autodirecto.cl"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Contrase√±a</label>
                        <input type="text" x-model="newUsuario.password" placeholder="admin1234"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm font-mono focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Rol</label>
                        <select x-model="newUsuario.role"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                            <option value="admin">Admin</option>
                            <option value="agent">Agente</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Sucursal</label>
                        <select x-model="newUsuario.sucursal"
                            class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500">
                            <option>Vitacura</option>
                            <option>Las Condes</option>
                            <option>Providencia</option>
                            <option>√ëu√±oa</option>
                            <option>Centro</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Color Avatar</label>
                        <div class="flex items-center gap-2">
                            <input type="color" x-model="newUsuario.color"
                                class="w-10 h-10 rounded cursor-pointer border-0 bg-transparent">
                            <span class="text-xs text-slate-400 font-mono" x-text="newUsuario.color"></span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button @click="saveNuevoUsuario()"
                        class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="ph ph-floppy-disk mr-1"></i> Crear Usuario
                    </button>
                    <button @click="usuarioAddOpen=false"
                        class="text-slate-400 hover:text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        Cancelar
                    </button>
                </div>
            </div>

            <!-- Users list -->
            <div class="bg-slate-800/30 border border-slate-800 rounded-xl overflow-hidden">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="border-b border-slate-800 text-xs text-slate-500 uppercase tracking-wider">
                            <th class="text-left px-4 py-3 font-medium">Usuario</th>
                            <th class="text-left px-4 py-3 font-medium">Email</th>
                            <th class="text-left px-4 py-3 font-medium">Rol</th>
                            <th class="text-left px-4 py-3 font-medium">Sucursal</th>
                            <th class="text-right px-4 py-3 font-medium">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="u in usuarios" :key="u.id">
                            <tr class="border-b border-slate-800/50 hover:bg-slate-800/30 transition-colors">
                                <td class="px-4 py-3">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0"
                                            :style="'background-color:' + (u.color || '#64748b')">
                                            <span x-text="(u.name||'?').charAt(0).toUpperCase()"></span>
                                        </div>
                                        <span class="text-white font-medium" x-text="u.name"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-slate-400 font-mono text-xs" x-text="u.email"></td>
                                <td class="px-4 py-3">
                                    <span
                                        :class="u.role==='admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400'"
                                        class="px-2 py-0.5 rounded-full text-xs font-medium capitalize"
                                        x-text="u.role"></span>
                                </td>
                                <td class="px-4 py-3 text-slate-400 text-xs" x-text="u.sucursal || 'Vitacura'"></td>
                                <td class="px-4 py-3 text-right">
                                    <button @click="deleteUsuario(u.id)" x-show="u.email !== currentUser?.email"
                                        class="text-slate-500 hover:text-red-400 transition-colors text-xs px-2 py-1 rounded hover:bg-red-500/10">
                                        <i class="ph ph-trash"></i> Desactivar
                                    </button>
                                    <span x-show="u.email === currentUser?.email"
                                        class="text-[10px] text-slate-600">(t√∫)</span>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="usuarios.length === 0">
                            <td colspan="5" class="text-center py-8 text-slate-600 text-sm">No hay usuarios activos</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Info note -->
            <div class="flex items-start gap-3 p-4 bg-amber-500/10 border border-amber-500/20 rounded-xl">
                <i class="ph ph-info text-amber-400 text-lg mt-0.5 flex-shrink-0"></i>
                <div>
                    <p class="text-xs text-amber-300 font-medium">Credenciales de acceso</p>
                    <p class="text-xs text-slate-400 mt-1">Los usuarios acceden con su email y contrase√±a en <code
                            class="font-mono bg-slate-800 px-1 rounded">localhost:8080</code>. El admin por defecto es
                        <code class="font-mono bg-slate-800 px-1 rounded">admin@autodirecto.cl / admin1234</code>.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         LOGIN SCREEN
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div x-show="!currentUser" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center"
        style="display:none;">
        <div class="w-full max-w-sm mx-4">
            <!-- Logo / Brand -->
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 rounded-2xl mb-4 shadow-lg shadow-blue-900/40">
                    <i class="ph ph-car-simple text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Autodirecto CRM</h1>
                <p class="text-slate-500 text-sm mt-1">Sistema de Gesti√≥n Automotriz</p>
            </div>

            <!-- Card -->
            <div class="glass rounded-2xl p-8 shadow-2xl border border-slate-800">
                <div x-show="loginError"
                    class="bg-red-500/15 border border-red-500/30 text-red-400 text-sm rounded-lg px-4 py-3 mb-5 flex items-center gap-2"
                    style="display:none;">
                    <i class="ph ph-warning-circle"></i>
                    <span x-text="loginError"></span>
                </div>
                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-xs text-slate-400 mb-1.5 font-medium uppercase tracking-wider">Email</label>
                        <input type="email" x-model="loginEmail" @keydown.enter="doLogin()"
                            placeholder="admin@autodirecto.cl"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                    <div>
                        <label
                            class="block text-xs text-slate-400 mb-1.5 font-medium uppercase tracking-wider">Contrase√±a</label>
                        <input type="password" x-model="loginPassword" @keydown.enter="doLogin()" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-white placeholder-slate-600 focus:outline-none focus:border-blue-500 transition-colors">
                    </div>
                    <button @click="doLogin()" :disabled="loginLoading"
                        class="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white py-3 rounded-xl font-semibold transition-all shadow-lg shadow-blue-900/30">
                        <span x-show="!loginLoading" class="flex items-center justify-center gap-2">
                            <i class="ph ph-sign-in"></i> Iniciar Sesi√≥n
                        </span>
                        <span x-show="loginLoading" class="flex items-center justify-center gap-2"
                            style="display:none;">
                            <i class="ph ph-spinner animate-spin"></i> Verificando...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DTE Generator Modal -->
    <div x-show="modals.dte" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm"
        style="display: none;">
        <div class="glass w-full max-w-lg rounded-2xl p-8 shadow-2xl text-center" @click.away="closeModal('dte')">
            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph ph-file-text text-3xl text-blue-400"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Generar Liquidaci√≥n Factura</h3>
            <p class="text-slate-400 text-sm mb-6"
                x-text="'Para: ' + (activeCar?.brand || '') + ' ' + (activeCar?.model || '')"></p>

            <div class="bg-slate-800/50 rounded-lg p-4 text-left text-sm space-y-2 mb-6 border border-slate-700">
                <div class="flex justify-between">
                    <span class="text-slate-400">Tipo DTE</span>
                    <span class="text-white font-mono">43 (Liquidaci√≥n)</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-400">Neto (Comisi√≥n)</span>
                    <span class="text-white font-mono" x-text="formatCLP(activeCar?.commission_amount)"></span>
                </div>
                <div class="flex justify-between">
                    <span class="text-slate-400">IVA (19%)</span>
                    <span class="text-white font-mono" x-text="formatCLP(activeCar?.iva_on_commission)"></span>
                </div>
                <div class="border-t border-slate-700 pt-2 flex justify-between font-bold">
                    <span class="text-slate-300">Total</span>
                    <span class="text-blue-400" x-text="formatCLP(activeCar?.gross_commission)"></span>
                </div>
            </div>

            <button @click="generateAndSendDTE()"
                class="w-full bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-lg font-medium shadow-lg shadow-green-900/20 transition-all flex items-center justify-center gap-2"
                :disabled="dteLoading">
                <i class="ph ph-paper-plane-tilt" x-show="!dteLoading"></i>
                <i class="ph ph-spinner animate-spin" x-show="dteLoading"></i>
                <span x-text="dteLoading ? 'Enviando a SII...' : 'Emitir Documento (Sandbox)'"></span>
            </button>
        </div>
    </div>

    <script>
        function appData() {
            return {
                currentView: 'dashboard',
                cars: [],
                stats: { total: 0, total_commission: 0, draft_dte: 0, total_ventas: 0 },
                modals: { addCar: false, dte: false, crmAdd: false },
                newCar: { commission_pct: 0.10 },
                activeCar: null,
                dteLoading: false,

                // ‚îÄ‚îÄ‚îÄ Auth State ‚îÄ‚îÄ‚îÄ
                currentUser: null,
                loginEmail: '',
                loginPassword: '',
                loginError: '',
                loginLoading: false,
                mrcarUrl: 'http://localhost:3001',

                // ‚îÄ‚îÄ‚îÄ Usuarios State ‚îÄ‚îÄ‚îÄ
                usuarios: [],
                usuariosLoading: false,
                usuarioAddOpen: false,
                newUsuario: { name: '', email: '', role: 'agent', color: '#3b82f6', sucursal: 'Vitacura', password: 'admin1234' },

                // ‚îÄ‚îÄ‚îÄ CRM State ‚îÄ‚îÄ‚îÄ
                crmLeads: [],
                crmStats: { total: 0, pipeline: {}, sources: {}, recent_7d: 0, needs_followup: 0 },
                crmViewMode: 'kanban',
                crmSearch: '',
                crmFilterStage: null,
                crmDetailOpen: false,
                crmDetail: null,
                crmDetailNotes: '',
                addCRMNoteModal: false,
                newCRMNoteTitle: '',
                newCRMNoteDesc: '',
                newCRMLead: { stage: 'nuevo', priority: 'medium', source: 'manual' },
                crmStageOrder: ['nuevo', 'contactado', 'agendado', 'inspeccionado', 'en_venta', 'vendido', 'descartado'],
                crmStageLabels: {
                    nuevo: 'Nuevo', contactado: 'Contactado', agendado: 'Agendado',
                    inspeccionado: 'Inspeccionado', en_venta: 'En Venta', vendido: 'Vendido', descartado: 'Descartado'
                },
                crmStageColors: {
                    nuevo: { dot: 'bg-sky-400', active: 'bg-sky-600/30 text-sky-300 border-sky-500/30', badge: 'bg-sky-500/20 text-sky-400' },
                    contactado: { dot: 'bg-blue-400', active: 'bg-blue-600/30 text-blue-300 border-blue-500/30', badge: 'bg-blue-500/20 text-blue-400' },
                    agendado: { dot: 'bg-purple-400', active: 'bg-purple-600/30 text-purple-300 border-purple-500/30', badge: 'bg-purple-500/20 text-purple-400' },
                    inspeccionado: { dot: 'bg-amber-400', active: 'bg-amber-600/30 text-amber-300 border-amber-500/30', badge: 'bg-amber-500/20 text-amber-400' },
                    en_venta: { dot: 'bg-orange-400', active: 'bg-orange-600/30 text-orange-300 border-orange-500/30', badge: 'bg-orange-500/20 text-orange-400' },
                    vendido: { dot: 'bg-green-400', active: 'bg-green-600/30 text-green-300 border-green-500/30', badge: 'bg-green-500/20 text-green-400' },
                    descartado: { dot: 'bg-slate-500', active: 'bg-slate-600/30 text-slate-300 border-slate-500/30', badge: 'bg-slate-700 text-slate-400' },
                },

                async init() {
                    await this.checkAuth();
                    if (this.currentUser) {
                        await this.refresh();
                        try {
                            const r = await fetch('/api/crm/stats');
                            this.crmStats = await r.json();
                        } catch (e) { }
                    }
                },

                // ‚îÄ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ
                async checkAuth() {
                    try {
                        const r = await fetch('/api/auth/me');
                        if (r.ok) this.currentUser = await r.json();
                    } catch (e) { }
                },

                async doLogin() {
                    this.loginLoading = true;
                    this.loginError = '';
                    try {
                        const r = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: this.loginEmail, password: this.loginPassword })
                        });
                        const d = await r.json();
                        if (d.ok) {
                            this.currentUser = d.user;
                            await this.refresh();
                            try {
                                const s = await fetch('/api/crm/stats');
                                this.crmStats = await s.json();
                            } catch (e) { }
                        } else {
                            this.loginError = d.error || 'Credenciales incorrectas';
                        }
                    } catch (e) {
                        this.loginError = 'Error de conexi√≥n. ¬øEst√° corriendo el servidor?';
                    }
                    this.loginLoading = false;
                },

                async doLogout() {
                    await fetch('/api/auth/logout', { method: 'POST' });
                    this.currentUser = null;
                },

                // ‚îÄ‚îÄ‚îÄ Usuarios ‚îÄ‚îÄ‚îÄ
                async loadUsuarios() {
                    this.usuariosLoading = true;
                    try {
                        const r = await fetch('/api/users');
                        this.usuarios = await r.json();
                    } catch (e) { }
                    this.usuariosLoading = false;
                },

                async saveNuevoUsuario() {
                    const r = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newUsuario)
                    });
                    if (r.ok) {
                        this.newUsuario = { name: '', email: '', role: 'agent', color: '#3b82f6', sucursal: 'Vitacura', password: 'admin1234' };
                        this.usuarioAddOpen = false;
                        await this.loadUsuarios();
                    } else {
                        const e = await r.json();
                        alert('Error: ' + (e.error || 'Unknown'));
                    }
                },

                async deleteUsuario(id) {
                    if (!confirm('¬øDesactivar este usuario?')) return;
                    await fetch('/api/users/' + id, { method: 'DELETE' });
                    await this.loadUsuarios();
                },

                async refresh() {
                    const [carsRes, statsRes] = await Promise.all([
                        fetch('/api/cars'),
                        fetch('/api/stats')
                    ]);
                    this.cars = await carsRes.json();
                    this.stats = await statsRes.json();
                },

                formatCLP(val) {
                    if (!val && val !== 0) return '';
                    return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(val);
                },

                formatStatus(status) {
                    const map = {
                        'available': 'Disponible',
                        'sold': 'Vendido',
                        'draft_dte': 'DTE Borrador',
                        'sent_dte': 'DTE Enviado'
                    };
                    return map[status] || status;
                },

                openModal(name) {
                    this.modals[name] = true;
                },

                closeModal(name) {
                    this.modals[name] = false;
                },

                openDTEModal(car) {
                    this.activeCar = car;
                    this.openModal('dte');
                },

                async submitCar() {
                    const res = await fetch('/api/cars', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newCar)
                    });
                    if (res.ok) {
                        this.closeModal('addCar');
                        this.newCar = { commission_pct: 0.10 }; // reset
                        this.refresh();
                    } else {
                        const err = await res.json();
                        alert('Error: ' + err.error);
                    }
                },

                async generateAndSendDTE() {
                    if (!this.activeCar) return;
                    this.dteLoading = true;
                    try {
                        // 1. Generate Draft
                        const step1 = await fetch(`/api/dte/generate/${this.activeCar.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data1 = await step1.json();

                        if (!data1.ok) throw new Error("Error generando draft DTE");

                        // 2. Simulate Send
                        const step2 = await fetch(`/api/dte/simulate_send/${this.activeCar.id}`, { method: 'POST' });
                        const data2 = await step2.json();

                        alert(data2.message);
                        this.closeModal('dte');
                        this.refresh();
                    } catch (e) {
                        alert(e.message);
                    } finally {
                        this.dteLoading = false;
                    }
                },

                // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                formatDate(dateStr) {
                    if (!dateStr) return '';
                    try {
                        const d = new Date(dateStr);
                        return d.toLocaleDateString('es-CL', { day: '2-digit', month: 'short', year: 'numeric' });
                    } catch (e) {
                        return dateStr;
                    }
                },

                // ‚îÄ‚îÄ‚îÄ Calendar State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                calYear: new Date().getFullYear(),
                calMonth: new Date().getMonth() + 1,
                calEvents: [],
                calUsers: [],
                calSelectedDay: null,
                calEventOpen: false,
                calActiveEvent: null,

                get calMonthLabel() {
                    const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                        'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                    return months[this.calMonth - 1] + ' ' + this.calYear;
                },

                get calSelectedDayLabel() {
                    if (!this.calSelectedDay) return '';
                    const [y, m, d] = this.calSelectedDay.split('-');
                    const days = ['domingo', 'lunes', 'martes', 'mi√©rcoles', 'jueves', 'viernes', 's√°bado'];
                    const dt = new Date(+y, +m - 1, +d);
                    return days[dt.getDay()] + ' ' + +d + ' de ' + this.calMonthLabel;
                },

                get calSelectedDayEvents() {
                    if (!this.calSelectedDay) return [];
                    return this.calEvents.filter(e => e.appointment_date === this.calSelectedDay);
                },

                get calGrid() {
                    const firstDay = new Date(this.calYear, this.calMonth - 1, 1);
                    // Monday-first: (0=Sun ‚Üí 6, 1=Mon ‚Üí 0, ... 6=Sat ‚Üí 5)
                    let startDow = firstDay.getDay();
                    startDow = startDow === 0 ? 6 : startDow - 1;
                    const daysInMonth = new Date(this.calYear, this.calMonth, 0).getDate();
                    const today = new Date().toISOString().slice(0, 10);
                    const cells = [];
                    // Padding before
                    for (let i = 0; i < startDow; i++) cells.push({ date: null, day: null, events: [] });
                    // Month days
                    for (let d = 1; d <= daysInMonth; d++) {
                        const dateStr = this.calYear + '-' + String(this.calMonth).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                        cells.push({
                            date: dateStr,
                            day: d,
                            isToday: dateStr === today,
                            events: this.calEvents.filter(e => e.appointment_date === dateStr)
                        });
                    }
                    // Padding after (fill to complete last row)
                    while (cells.length % 7 !== 0) cells.push({ date: null, day: null, events: [] });
                    return cells;
                },

                async loadCalendar() {
                    const [evRes, uRes] = await Promise.all([
                        fetch(`/api/calendar?year=${this.calYear}&month=${this.calMonth}`),
                        fetch('/api/users')
                    ]);
                    this.calEvents = await evRes.json();
                    this.calUsers = await uRes.json();
                },

                calPrevMonth() {
                    if (this.calMonth === 1) { this.calMonth = 12; this.calYear--; }
                    else this.calMonth--;
                    this.loadCalendar();
                },

                calNextMonth() {
                    if (this.calMonth === 12) { this.calMonth = 1; this.calYear++; }
                    else this.calMonth++;
                    this.loadCalendar();
                },

                selectCalDay(date) {
                    this.calSelectedDay = date;
                },

                openCalEvent(ev) {
                    this.calActiveEvent = { ...ev };
                    this.calEventOpen = true;
                },

                async calAssignUser(ev, userId) {
                    if (!ev?.id) return;
                    const res = await fetch('/api/calendar/assign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ supabase_id: ev.id, user_id: userId })
                    });
                    const data = await res.json();
                    if (data.ok) {
                        await this.loadCalendar();
                        // Refresh active event
                        const updated = this.calEvents.find(e => e.id === ev.id);
                        if (updated) this.calActiveEvent = { ...updated };
                    }
                },

                async calCreateConsignacion(ev) {
                    if (!ev?.id || !ev?.assigned_user_id) return;
                    const res = await fetch('/api/calendar/assign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ supabase_id: ev.id, user_id: ev.assigned_user_id })
                    });
                    const data = await res.json();
                    if (data.ok) {
                        await this.loadCalendar();
                        const updated = this.calEvents.find(e => e.id === ev.id);
                        if (updated) this.calActiveEvent = { ...updated };
                    }
                },

                // ‚îÄ‚îÄ‚îÄ Consignaciones State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                consignaciones: [],
                consigFilter: 'todas',
                consigDetail: null,
                consigDetailOpen: false,
                consigEdits: {},

                // ‚îÄ‚îÄ‚îÄ Inspection State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                inspectionOpen: false,
                inspStep: 1,
                inspSaving: false,
                publishingId: null,
                inspSteps: [
                    { label: 'Datos del Due√±o & Veh√≠culo', desc: 'Informaci√≥n b√°sica del propietario y el auto' },
                    { label: 'Documentaci√≥n & Precios', desc: 'Permisos, revisi√≥n t√©cnica y valores' },
                    { label: 'Equipamiento', desc: 'Caracter√≠sticas y accesorios del veh√≠culo' },
                    { label: 'T√©cnico & Fotos', desc: 'Estado f√≠sico, neum√°ticos y galer√≠a de fotos' },
                    { label: 'Revisi√≥n & Guardar', desc: 'Confirma los datos antes de guardar' },
                ],
                insp: {},

                // ‚îÄ‚îÄ‚îÄ Inspection Viewer State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                inspViewOpen: false,
                inspViewLoading: false,
                inspViewId: null,
                inspViewData: null,
                inspEmailOpen: false,
                inspEmailTo: '',
                inspEmailCc: '',
                inspEmailSubject: '',
                inspEmailSending: false,

                // ‚îÄ‚îÄ‚îÄ Contract Signing State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                contractOpen: false,
                contractLoading: false,
                contractConsigId: null,
                contractPlate: '',
                contractClientName: '',
                contractClientRut: '',
                contractSigned: false,
                contractSigning: false,
                signatureStarted: false,
                contractIframeSrc: '',
                _sigCtx: null,
                _sigDrawing: false,

                openContract(consigId) {
                    const c = this.consigDetail || {};
                    this.contractConsigId = consigId;
                    this.contractPlate = (c.plate || '').toUpperCase();
                    this.contractClientName = (c.owner_first_name || '') + ' ' + (c.owner_last_name || '');
                    this.contractClientRut = c.owner_rut || '';
                    this.contractSigned = !!c.contract_signed_at;
                    this.contractLoading = true;
                    this.contractIframeSrc = '';
                    this.contractOpen = true;
                    this.signatureStarted = false;
                    // Set iframe src with cache-busting timestamp
                    this.$nextTick(() => {
                        if (this.contractSigned) {
                            this.contractIframeSrc = '/api/consignaciones/' + consigId + '/contrato/descargar?t=' + Date.now();
                        } else {
                            this.contractIframeSrc = '/api/consignaciones/' + consigId + '/contrato?t=' + Date.now();
                        }
                        const canvas = document.getElementById('signatureCanvas');
                        if (canvas) {
                            canvas.width = canvas.offsetWidth;
                            canvas.height = canvas.offsetHeight;
                            this._sigCtx = canvas.getContext('2d');
                            this._sigCtx.strokeStyle = '#1a1a2e';
                            this._sigCtx.lineWidth = 2.5;
                            this._sigCtx.lineCap = 'round';
                            this._sigCtx.lineJoin = 'round';
                        }
                    });
                },

                startDrawing(e) {
                    if (!this._sigCtx) return;
                    this._sigDrawing = true;
                    this.signatureStarted = true;
                    const rect = e.target.getBoundingClientRect();
                    this._sigCtx.beginPath();
                    this._sigCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
                },

                draw(e) {
                    if (!this._sigDrawing || !this._sigCtx) return;
                    const rect = e.target.getBoundingClientRect();
                    this._sigCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                    this._sigCtx.stroke();
                },

                startDrawingTouch(e) {
                    if (!this._sigCtx) return;
                    this._sigDrawing = true;
                    this.signatureStarted = true;
                    const rect = e.target.getBoundingClientRect();
                    const touch = e.touches[0];
                    this._sigCtx.beginPath();
                    this._sigCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
                },

                drawTouch(e) {
                    if (!this._sigDrawing || !this._sigCtx) return;
                    const rect = e.target.getBoundingClientRect();
                    const touch = e.touches[0];
                    this._sigCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                    this._sigCtx.stroke();
                },

                stopDrawing() {
                    this._sigDrawing = false;
                },

                clearSignature() {
                    const canvas = document.getElementById('signatureCanvas');
                    if (canvas && this._sigCtx) {
                        this._sigCtx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                    this.signatureStarted = false;
                },

                async submitSignature() {
                    const canvas = document.getElementById('signatureCanvas');
                    if (!canvas || !this.signatureStarted) return;
                    this.contractSigning = true;
                    try {
                        const sigData = canvas.toDataURL('image/png');
                        const res = await fetch(`/api/consignaciones/${this.contractConsigId}/contrato/firmar`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ signature: sigData })
                        });
                        const data = await res.json();
                        if (data.ok) {
                            this.contractSigned = true;
                            // Refresh the contract preview with signed version
                            this.contractLoading = true;
                            this.$nextTick(() => {
                                this.contractIframeSrc = '/api/consignaciones/' + this.contractConsigId + '/contrato/descargar?t=' + Date.now();
                            });
                            // Refresh consignacion detail
                            if (this.consigDetail?.id) {
                                await this.openConsignacion(this.consigDetail.id);
                            }
                            alert('‚úÖ Contrato firmado exitosamente.\n\nEl contrato ha sido firmado digitalmente y guardado.');
                        } else {
                            alert('‚ùå Error: ' + (data.error || 'Error firmando'));
                        }
                    } catch (e) {
                        alert('‚ùå Error: ' + e.message);
                    }
                    this.contractSigning = false;
                },

                async viewInspection(appraisalId) {
                    this.inspViewId = appraisalId;
                    this.inspViewLoading = true;
                    this.inspViewOpen = true;
                    this.inspEmailTo = this.consigDetail?.owner_email || '';
                    this.inspEmailCc = '';
                    this.inspEmailSubject = '';
                    try {
                        const res = await fetch('/api/inspecciones/' + appraisalId);
                        this.inspViewData = await res.json();
                    } catch (e) {
                        console.error('Error loading inspection:', e);
                    }
                },

                async sendInspEmail() {
                    if (!this.inspEmailTo) return;
                    this.inspEmailSending = true;
                    try {
                        const res = await fetch('/api/inspecciones/' + this.inspViewId + '/email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                to: this.inspEmailTo,
                                cc: this.inspEmailCc || undefined,
                                subject: this.inspEmailSubject || undefined,
                            })
                        });
                        const data = await res.json();
                        if (data.ok) {
                            this.inspEmailOpen = false;
                            alert('‚úÖ Email enviado correctamente a ' + this.inspEmailTo);
                        } else {
                            alert('‚ùå Error: ' + (data.error || 'No se pudo enviar'));
                        }
                    } catch (e) {
                        alert('‚ùå Error de conexi√≥n: ' + e.message);
                    }
                    this.inspEmailSending = false;
                },

                openInspection(c) {
                    this.insp = {
                        // Client
                        clientNombre: c?.owner_first_name || '',
                        clientApellido: c?.owner_last_name || '',
                        clientRut: c?.owner_rut || '',
                        clientTelefono: (c?.owner_country_code || '+56') + (c?.owner_phone || ''),
                        clientEmail: c?.owner_email || '',
                        clientDireccion: [c?.owner_address, c?.owner_commune, c?.owner_region].filter(Boolean).join(', '),
                        // Vehicle
                        vehiclePatente: c?.plate || '',
                        vehicleMarca: c?.car_make || '',
                        vehicleModelo: c?.car_model || '',
                        vehicleVersion: c?.version || '',
                        vehicleAno: c?.car_year || new Date().getFullYear(),
                        vehicleKm: c?.mileage || 0,
                        vehicleColor: c?.color || '',
                        vehicleMotor: '',
                        vehicleTransmision: 'Manual',
                        vehicleCombustible: 'Bencina',
                        vehicleBodyType: '',
                        digitoPatente: '',
                        traccion: '',
                        // Docs
                        permisoCirculacion: null,
                        permisoVence: '',
                        revisionTecnica: null,
                        revisionVence: '',
                        soap: null,
                        soapCompania: '',
                        // Pricing
                        aiMarketPrice: c?.ai_market_price || null,
                        aiInstantBuyPrice: c?.ai_instant_buy_price || null,
                        tasacion: c?.market_value || null,
                        precioPublicado: c?.listing_price || null,
                        precioSugerido: c?.ai_market_price || c?.selling_price || c?.proposed_price || c?.market_value || null,
                        comision: c?.commission || null,
                        numDuenos: null,
                        // Legal
                        enPrenda: false,
                        enRemate: false,
                        // Technical
                        airbags: null,
                        numLlaves: 2,
                        neumaticos: [true, true, true, true, true],
                        quienTomoFotos: '',
                        observaciones: '',
                        // Features
                        features: {
                            aireAcondicionado: false, bluetooth: false, calefactorAsiento: false,
                            conexionUsb: false, gps: false, isofix: false, smartKey: false,
                            lucesLed: false, mandosVolante: false, sensorEstacionamiento: false,
                            sonidoPremium: false, techoElectrico: false, ventiladorAsiento: false,
                            carplayAndroid: false,
                        },
                        // Photos
                        photos: [],
                        // Link back
                        _consignacionId: c?.id,
                    };
                    this.inspStep = 1;
                    this.inspectionOpen = true;
                },

                handlePhotoUpload(event) {
                    const files = Array.from(event.target.files);
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            this.insp.photos.push({ name: file.name, preview: e.target.result, file });
                        };
                        reader.readAsDataURL(file);
                    });
                    event.target.value = '';
                },

                async submitInspection() {
                    this.inspSaving = true;
                    try {
                        const payload = {
                            consignacion_id: this.insp._consignacionId,
                            // Client
                            client_nombre: this.insp.clientNombre,
                            client_apellido: this.insp.clientApellido,
                            client_rut: this.insp.clientRut,
                            client_telefono: this.insp.clientTelefono,
                            client_email: this.insp.clientEmail || null,
                            client_direccion: this.insp.clientDireccion || null,
                            // Vehicle ‚Äî exact Supabase column names
                            vehicle_patente: this.insp.vehiclePatente,
                            vehicle_marca: this.insp.vehicleMarca,
                            vehicle_modelo: this.insp.vehicleModelo,
                            vehicle_version: this.insp.vehicleVersion || null,
                            'vehicle_a√±o': this.insp.vehicleAno,
                            vehicle_km: this.insp.vehicleKm,
                            vehicle_color: this.insp.vehicleColor || null,
                            vehicle_motor: this.insp.vehicleMotor || null,
                            vehicle_transmision: this.insp.vehicleTransmision,
                            vehicle_combustible: this.insp.vehicleCombustible,
                            traccion: this.insp.traccion || null,
                            digito_patente: this.insp.digitoPatente || null,
                            // Docs
                            permiso_circulacion: this.insp.permisoCirculacion,
                            vence_permiso: this.insp.permisoVence || null,
                            revision_tecnica: this.insp.revisionTecnica,
                            vence_revision: this.insp.revisionVence || null,
                            soap: this.insp.soap,
                            soap_compania: this.insp.soapCompania || null,
                            // Pricing
                            ai_market_price: this.insp.aiMarketPrice || null,
                            ai_instant_buy_price: this.insp.aiInstantBuyPrice || null,
                            tasacion: this.insp.tasacion || null,
                            precio_publicado: this.insp.precioPublicado || null,
                            precio_sugerido: this.insp.precioSugerido || null,
                            comision: this.insp.comision || null,
                            'num_due√±os': this.insp.numDuenos || null,
                            // Legal
                            en_prenda: this.insp.enPrenda,
                            remate: this.insp.enRemate,
                            // Technical
                            airbags: this.insp.airbags || null,
                            num_llaves: this.insp.numLlaves,
                            neumaticos: this.insp.neumaticos,
                            quien_tomo_fotos: this.insp.quienTomoFotos || null,
                            observaciones: this.insp.observaciones || null,
                            // Features ‚Äî JSON blob + individual boolean columns
                            features: this.insp.features,
                            calefactor_asiento: !!this.insp.features.calefactorAsiento,
                            conexion_usb: !!this.insp.features.conexionUsb,
                            gps: !!this.insp.features.gps,
                            isofix: !!this.insp.features.isofix,
                            smart_key: !!this.insp.features.smartKey,
                            luces_led: !!this.insp.features.lucesLed,
                            mandos_volante: !!this.insp.features.mandosVolante,
                            sensor_estacionamiento: !!this.insp.features.sensorEstacionamiento,
                            sonido_premium: !!this.insp.features.sonidoPremium,
                            techo_electrico: !!this.insp.features.techoElectrico,
                            ventilador_asiento: !!this.insp.features.ventiladorAsiento,
                            carplay_android: !!this.insp.features.carplayAndroid,
                            status: 'completed',
                        };

                        // POST to SimplyAPI proxy ‚Üí Supabase
                        const res = await fetch('/api/inspecciones', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();

                        if (!data.ok) throw new Error(data.error || 'Error guardando');

                        // Upload photos if any
                        if (this.insp.photos.length > 0 && data.appraisal_id) {
                            for (const photo of this.insp.photos) {
                                const fd = new FormData();
                                fd.append('file', photo.file);
                                fd.append('appraisal_id', data.appraisal_id);
                                await fetch('/api/inspecciones/fotos', { method: 'POST', body: fd });
                            }
                        }

                        // Refresh consignacion detail
                        if (this.insp._consignacionId) {
                            await this.openConsignacion(this.insp._consignacionId);
                        }

                        this.inspectionOpen = false;
                        this.inspStep = 1;

                        // Open contract for signing
                        const consigId = this.insp._consignacionId;
                        if (consigId) {
                            const signNow = confirm('‚úÖ Inspecci√≥n guardada correctamente.\n\n¬øGenerar y firmar el contrato de consignaci√≥n ahora?');
                            if (signNow) {
                                this.openContract(consigId);
                            } else {
                                // Auto-send email if client has email
                                const clientEmail = this.insp.clientEmail;
                                if (clientEmail && data.appraisal_id) {
                                    const sendNow = confirm('¬øEnviar informe por email a ' + clientEmail + '?');
                                    if (sendNow) {
                                        try {
                                            const emailRes = await fetch('/api/inspecciones/' + data.appraisal_id + '/email', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ to: clientEmail })
                                            });
                                            const emailData = await emailRes.json();
                                            if (emailData.ok) {
                                                alert('üìß Email enviado a ' + clientEmail);
                                            } else {
                                                alert('‚ö†Ô∏è El email fall√≥: ' + (emailData.error || 'Error'));
                                            }
                                        } catch (emailErr) {
                                            alert('‚ö†Ô∏è El email fall√≥: ' + emailErr.message);
                                        }
                                    }
                                }
                            }
                        } else {
                            alert('‚úÖ Inspecci√≥n guardada correctamente');
                        }
                    } catch (e) {
                        alert('‚ùå Error: ' + e.message);
                    }
                    this.inspSaving = false;
                },

                inspValidate(step) {
                    const i = this.insp;
                    if (step === 1) {
                        const missing = [];
                        if (!i.clientNombre?.trim()) missing.push('Nombre');
                        if (!i.clientApellido?.trim()) missing.push('Apellido');
                        if (!i.clientRut?.trim()) missing.push('RUT');
                        if (!i.clientTelefono?.trim()) missing.push('Tel√©fono');
                        if (!i.vehiclePatente?.trim()) missing.push('Patente');
                        if (!i.vehicleMarca?.trim()) missing.push('Marca');
                        if (!i.vehicleModelo?.trim()) missing.push('Modelo');
                        if (!i.vehicleAno) missing.push('A√±o');
                        if (!i.vehicleKm && i.vehicleKm !== 0) missing.push('Kilometraje');
                        if (missing.length) {
                            alert('‚ö†Ô∏è Campos obligatorios:\n‚Ä¢ ' + missing.join('\n‚Ä¢ '));
                            return false;
                        }
                    }
                    return true;
                },

                async loadConsignaciones() {
                    const url = this.consigFilter && this.consigFilter !== 'todas'
                        ? `/api/consignaciones?status=${this.consigFilter}`
                        : '/api/consignaciones';
                    const res = await fetch(url);
                    this.consignaciones = await res.json();
                },

                async openConsignacion(id) {
                    const res = await fetch(`/api/consignaciones/${id}`);
                    this.consigDetail = await res.json();
                    this.consigEdits = {};
                    this.consigDetailOpen = true;
                },

                async saveConsignacion(id, data) {
                    const res = await fetch(`/api/consignaciones/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        this.consigEdits = {};
                        await this.openConsignacion(id);
                        await this.loadConsignaciones();
                        // If status changed, also refresh CRM + inventory
                        if (data.status) {
                            await this.loadCRM();
                            await this.refresh();
                        }
                    }
                },

                async promoteToInventory(id) {
                    if (!confirm('¬øPromover esta consignaci√≥n al inventario? Se crear√° un auto en el inventario.')) return;
                    const res = await fetch(`/api/consignaciones/${id}/promote`, { method: 'POST' });
                    const data = await res.json();
                    if (data.ok) {
                        this.consigDetailOpen = false;
                        await this.loadConsignaciones();
                        await this.refresh();
                        alert('‚úÖ Veh√≠culo agregado al inventario con ID #' + data.car_id);
                    } else {
                        alert('Error: ' + (data.error || 'No se pudo promover'));
                    }
                },

                async publishToWebsite(id) {
                    if (!confirm('¬øPublicar este veh√≠culo en el cat√°logo de autodirecto.cl?\n\nSe publicar√° en el sitio web y el auto pasar√° a "En Venta" en el CRM e Inventario.')) return;
                    this.publishingId = id;
                    try {
                        const res = await fetch(`/api/consignaciones/${id}/publicar`, { method: 'POST' });
                        const data = await res.json();
                        if (data.ok) {
                            // Refresh everything: detail, list, CRM, inventory
                            await this.openConsignacion(id);
                            await this.loadConsignaciones();
                            await this.loadCRM();
                            await this.refresh();
                            const photoMsg = data.image_count > 0 ? ` con ${data.image_count} foto(s)` : '';
                            alert(`‚úÖ Veh√≠culo publicado en el cat√°logo${photoMsg}.\n\n‚Ä¢ Publicado en autodirecto.cl/catalogo\n‚Ä¢ Movido a "En Venta"\n‚Ä¢ Agregado al inventario`);
                        } else {
                            alert('‚ùå Error al publicar: ' + (data.error || 'Error desconocido'));
                        }
                    } catch (e) {
                        alert('‚ùå Error de conexi√≥n: ' + e.message);
                    }
                    this.publishingId = null;
                },

                // ‚îÄ‚îÄ‚îÄ CRM Methods ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                async loadCRM() {
                    await Promise.all([this.loadCRMLeads(), this.loadCRMStats()]);
                },

                async loadCRMLeads() {
                    let url = '/api/crm/leads?';
                    if (this.crmFilterStage) url += 'stage=' + this.crmFilterStage + '&';
                    if (this.crmSearch) url += 'search=' + encodeURIComponent(this.crmSearch);
                    const res = await fetch(url);
                    this.crmLeads = await res.json();
                },

                async loadCRMStats() {
                    const res = await fetch('/api/crm/stats');
                    this.crmStats = await res.json();
                },

                async openCRMDetail(leadId) {
                    const res = await fetch('/api/crm/leads/' + leadId);
                    this.crmDetail = await res.json();
                    this.crmDetailNotes = this.crmDetail.notes || '';
                    this.addCRMNoteModal = false;
                    this.crmDetailOpen = true;
                },

                async updateCRMLeadStage(leadId, newStage) {
                    await fetch('/api/crm/leads/' + leadId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ stage: newStage })
                    });
                    // Refresh detail & list
                    await this.openCRMDetail(leadId);
                    await this.loadCRM();
                },

                async handleCRMDrop(event, newStage) {
                    const leadId = event.dataTransfer.getData('text/plain');
                    if (!leadId) return;
                    await this.updateCRMLeadStage(parseInt(leadId), newStage);
                },

                async saveCRMNotes(leadId) {
                    await fetch('/api/crm/leads/' + leadId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notes: this.crmDetailNotes })
                    });
                },

                async addCRMActivity(leadId, type, title) {
                    await fetch('/api/crm/leads/' + leadId + '/activities', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: type, title: title, created_by: 'user' })
                    });
                    await this.openCRMDetail(leadId);
                    await this.loadCRM();
                },

                async submitCRMNote(leadId) {
                    if (!this.newCRMNoteTitle.trim()) return;
                    await fetch('/api/crm/leads/' + leadId + '/activities', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'note',
                            title: this.newCRMNoteTitle,
                            description: this.newCRMNoteDesc,
                            created_by: 'user'
                        })
                    });
                    this.newCRMNoteTitle = '';
                    this.newCRMNoteDesc = '';
                    this.addCRMNoteModal = false;
                    await this.openCRMDetail(leadId);
                },

                async deleteCRMLead(leadId) {
                    if (!confirm('¬øEliminar este lead permanentemente?')) return;
                    await fetch('/api/crm/leads/' + leadId, { method: 'DELETE' });
                    this.crmDetailOpen = false;
                    this.crmDetail = null;
                    await this.loadCRM();
                },

                openCRMAddModal() {
                    this.newCRMLead = { stage: 'nuevo', priority: 'medium', source: 'manual' };
                    this.openModal('crmAdd');
                },

                async submitCRMLead() {
                    const res = await fetch('/api/crm/leads', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.newCRMLead)
                    });
                    if (res.ok) {
                        this.closeModal('crmAdd');
                        await this.loadCRM();
                    } else {
                        const err = await res.json();
                        alert('Error: ' + (err.error || 'Unknown'));
                    }
                },

                async syncFromSupabase() {
                    const res = await fetch('/api/crm/sync', { method: 'POST' });
                    const data = await res.json();
                    if (data.ok) {
                        alert('‚úÖ Sync completado: ' + data.imported + ' importados, ' + data.skipped + ' ya exist√≠an');
                        await this.loadCRM();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown'));
                    }
                },

                async importFromFunnels() {
                    const res = await fetch('/api/crm/import-funnels', { method: 'POST' });
                    const data = await res.json();
                    if (data.ok) {
                        alert('‚úÖ Funnels importado: ' + data.imported + ' nuevos, ' + data.skipped + ' ya exist√≠an');
                        await this.loadCRM();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown'));
                    }
                },
            }
        }
    </script>
</body>

</html>